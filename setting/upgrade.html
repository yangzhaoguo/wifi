

<!DOCTYPE html>
<!--[if lt IE 7]><html class="ie6 oldie" lang="zh"><![endif]-->
<!--[if IE 7]><html class="ie7 oldie" lang="zh"><![endif]-->
<!--[if IE 8]><html class="ie8 oldie" lang="zh"><![endif]-->
<!--[if gt IE 8]><!--> <html lang="zh"> <!--<![endif]-->
<head>
    <meta http-equiv="X-UA-Compatible" content="edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="renderer" content="webkit">
    <!--[if lt IE 7]>
    <meta http-equiv="refresh" content="0; url=http://miwifi.com/cgi-bin/luci/web/ieblock" />
    <![endif]-->
    <!--[if gte IE 9]>
    <style>
        body {
            filter: none;
        }
    </style>
    <![endif]-->
    <link rel="icon" href="../logo_ico.ico" type="img/x-ico"/>
    <title>灵铱路由器</title>
    <meta name="viewport" content="width=1200">
    <link href="/xuci/assets/css/bc.css-v=0.0.3.css" rel="stylesheet">
    <link href="/xuci/assets/css/qos.css-v=0.0.3.css" rel="stylesheet">
    <link href="/xuci/assets/css/index.css-v=0.0.3.css" rel="stylesheet">
    <link href="/xuci/assets/css/proset.css" rel="stylesheet">
    <link href="/xuci/assets/css/upgrade.css-v=0.0.3.css" rel="stylesheet">
</head>
<body>
<div id="doc">

    <noscript>
        <div class="noscript">你的浏览器禁止了Javascript功能，会造成无法使用系统进行路由器管理，请开启。</div>
    </noscript>
    <script>
        var GLOBALHEADER = true;
    </script>
    <div id="hd">
        <div class="inner">
            <div class="mod-head clearfix">
                <h1 id="logo">
                    <a href="../home.html">
                        <img src="/xuci/assets/img/logo.png" alt="灵铱路由器">
                    </a>
                </h1>
                <div id="nav">
                    <ul>
                        <li>
                            <a href="../home.html">路由状态</a>
                        </li>

                        <li class="active">
                            <a href="./wifi.html">常用设置</a>
                        </li>
                        <li>
                            <a href="../prosetting/qos.html">高级设置</a>
                        </li>
                    </ul>

                </div>
                <!--<div id="userbar">-->

                <!--<span id="sysmenu" class="name s-dropdown">Xiaomi_B504 (家)</span>-->
                <!--<span id="sysnotice" class="ico-notice"></span>-->
                <!--</div>-->
            </div>
        </div>
    </div>
    <div style="width: 1160px;margin: auto;">
        <div class="mod-set-nav">
            <ul class="clearfix li-5">
                <li>
                    <a href="wifi.html">
                        <i class="ico ico-1"></i>
                        <span>Wi-Fi设置</span>
                    </a>
                </li>
                <li>
                    <a href="./wan.html">
                        <i class="ico ico-2"></i>
                        <span>上网设置</span>
                    </a>
                </li>
                <li>
                    <a href="safe.html">
                        <i class="ico ico-3"></i>
                        <span>安全中心</span>
                    </a>
                </li>
                <li>
                    <a href="lannetset.html">
                        <i class="ico ico-4"></i>
                        <span>局域网设置</span>
                    </a>
                </li>
                <li class="active">
                    <a href="upgrade.html">
                        <i class="ico ico-5"></i>
                        <span>系统状态</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <div class="row top-state">
        <div class="col-sm-12 col-md-4 " >
            <p class="font2-p">固件升级</p>
        </div>
        <div class="col-sm-12 col-md-4 " >
            <div class="top-34">
                <label class="checkbox-inline font-p  text-left" id="inlineCheckbox" >
                    <input type="radio"  name="save"  onclick="savecfg()" value="1" checked> 不保留配置
                </label>
                <label class="checkbox-inline font-p  text-left" >
                    <input type="radio"  name="save" onclick="savecfg()" value="0" > 保留配置
                </label>
            </div>
            <form id="formid" enctype="multipart/form-data" method="post" action="/upload" target="rfFrame">
                <div class="top-34">
                    <span class="fileerrorTip"></span>
                    <span class="showFileName"></span>
                    <a href="javascript:;" class="file a-upload">选择文件
                        <input type="file" name="firmware" >
                    </a>
                </div>
            </form>
            <iframe id="rfFrame" name="rfFrame" src="about:blank" style="display:none;"></iframe>
        </div>
        <div class="col-sm-12 col-md-4 top-100">
            <button class="font3-p btn-primary top_30" id="button">升级</button>
        </div>
    </div>
    <div id="bd">
        <div class="mod-upgrade">
            <div class="hd"><h3>升级检测</h3></div>
            <div class="bd">
                <h4>系统版本</h4>
                <p id="upgradeinfo">当前版本<em class="em" id="upgradeinfoNumber">1.1.0</em></p>
                <p class="hasnewver" style="display:none;"><a href="/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/web/syslock?flashtype=download" class="btn btn-primary btn-l" id="btnUpgread"><span>立即升级</span></a></p>
                <p><a href="#" id="btnUpload" class="btn btn-dft btn-l"><span>手动升级</span></a></p>
                <div class="logs" style="display:none;">
                    <h4>更新日志</h4>
                    <div id="changelog" style="display:none;">
                        <iframe name="setting" id="changelogUrl" style="width:100%; border:0;background:none;" src="about:blank" frameborder="0" height="500" scrolling="yes"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!--<div class="mod-uploadlog">-->
            <!--<div class="hd">-->
                <!--<h3>上传日志</h3>-->
            <!--</div>-->
            <!--<div class="bd">-->
                <!--<div style="margin-bottom:15px;"><button type="button" id="btnUploadlog" class="btn btn-primary btn-l"><span>上传日志</span></button></div>-->

            <!--</div>-->
        <!--</div>-->

        <div class="mod-uploadlog">
            <div class="hd">
                <h3>恢复出厂设置</h3>
            </div>
            <div class="bd">
                <button type="button" id="btnReset" class="btn btn-primary btn-l"><span>立即恢复</span></button>
            </div>
        </div>

        <div class="mod-set mod-backupconfig">
            <div class="hd">
                <h3>备份与恢复</h3>
            </div>
            <div class="bd">
                <p>备份路由器的配置，重新刷机或重置路由器后可以用来恢复。</p>
                <div class="btns">
                    <a href="#" id="btnBackupconfig" class="btn btn-dft btn-m"><span>新建备份</span></a>
                    <a href="#" id="btnUploadconfig" class="btn btn-dft btn-m"><span>立即恢复</span></a>
                </div>
            </div>
        </div>


        <!--<div class="mod-set mod-systime">-->
            <!--<div class="hd">-->
                <!--<h3>时间设置</h3>-->
            <!--</div>-->
            <!--<div class="bd">-->
                <!--<div class="group">-->
                    <!--<p id="timezoneval">(UTC+8)北京,重庆,香港特别行政区,乌鲁木齐</p>-->
                    <!--<button type="button" id="btnTimezone" class="btn btn-dft btn-m"><span>更改时区</span></button>-->
                <!--</div>-->
                <!--<div class="group">-->
                    <!--<p id="datetiemval">2017年8月26日 00:55:24</p>-->
                    <!--<button type="button" id="btnDatetime" class="btn btn-dft btn-m"><span>更改时间</span></button>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->

    </div>

    <div id="ft">
        <p class="rom-ver">系统版本: 2.25.122 开发版  MAC地址: 78:11:DC:4C:B5:04</p>
        <p>&copy; 2018 灵铱路由器</p>
    </div>
    <script type="text/template" id="ft_template">
        <p class="rom-ver">系统版本: <%=(data.fv)%> 开发版  MAC地址: <%=(data.mac)%></p>
        <p>&copy; 2018 灵铱路由器</p>
    </script>

</div>

<!--[if lt IE 7]>
<script>
    try{ document.execCommand("BackgroundImageCache",false,true);} catch(e){}
</script>
<![endif]-->
<div class="mask-menu" id="maskMenu" style="position:fixed;left:0;top:0; width:100%; height:100%; z-index:2; display:none;"></div>
<div id="dropmenu" class="dropmenu" style="z-index:3; display:none;">
    <ul>
        <li><a href="#" id="toRename">修改路由器名称</a></li>

        <li><a href="/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/web/setting/upgrade">系统升级</a></li>

        <li><a href="#" id="toDownloadClient">下载客户端</a></li>
        <li><a href="#" id="toReboot">重启</a></li>
        <li class="last"><a href="/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/web/logout">注销</a></li>
    </ul>
</div>
<div id="noticebar" class="noticebar" style="z-index:3; display:none;">
    <i class="ico-arrow"></i>
    <div class="content"></div>
</div>
<script>
    var i18n = {};
    i18n.dialog = {
        ok: '确认',
        cancel: '取消',
        loading: '加载中...',
        dlgtitle: '消息框'
    };
    i18n.valid = {
        n_integer: '请输入一个{$0}位正整数。',
        n_format: '数字输入格式为&#34;{$0}&#34;。',
        n_upper: '输入值太大，最大允许{$0}。', //注意：{$0}表示允许值，{$1}表示实际值
        n_lower: '输入值太小，最小允许{$0}。',
        nrange_from: '您输入的范围不合理。',
        nrange_to: '您输入的范围不合理。',
        n_useless_zero: '数字前面好像有多余的&#34;0&#34;。',
        d_format: '日期输入格式为&#34;YYYY-MM-DD&#34;。',
        d_upper: '日期太晚，最晚允许{$0}。',
        d_lower: '日期太早，最早允许{$0}。',
        daterange_from: '起始日期不能大于截止日期。',
        daterange_to: '截止日期不能小于起始日期。',
        daterange_larger_span: "时间跨度不得超过{$0}天。",
        text_longer: '最多允许{$0}个字。', //'{$1}字太多，最多允许{$0}字'
        text_shorter: '请至少输入{$0}个字。', //'{$1}字太少，最少允许{$0}字'
        bytetext_longer: '最多允许{$0}个字节。', //'{$1}字节太多，最多允许{$0}字节'
        bytetext_shorter: '请至少输入{$0}个字节。', //'{$1}字节太少，最少允许{$0}字节'
        richtext_longer: '最多允许{$0}个字。',
        richtext_shorter: '请至少输入{$0}个字。',
        _reconfirm: '两次输入不一致。',
        _time: '请检查您输入的时间格式。',
        _minute: '请检查您输入的时间格式。',
        _email: '请检查您输入的Email格式。',
        _mobilecode: '请检查您输入的手机号码。',
        _phone: '请检查您输入的电话号码。',
        _phonewithext: '请检查您输入的电话号码。',
        _phonezone: '请检查您输入的电话区号。',
        _phonecode: '请检查您输入的电话号码。',
        _phoneext: '请检查您输入的电话分机号码。',
        _zipcode: '请检查您输入的邮政编码。',
        _idnumber: '请检查您输入的身份证号码，目前只支持15位或者18位。',
        _bankcard: '请检查您输入的银行账号。',
        _cnname: '请检查您输入的姓名。',
        _vcode: '请检查您输入的验证码。',
        _imgfile: '请检查您选择的图片文件路径，只支持jpg、jpeg、png、gif、tif、bmp格式。',
        _regexp: '请检查您的输入。',
        _magic: '请检查您的输入。',
        _req_text: '请填写{$0}。',
        _req_select: '请选择{$0}。',
        _req_file: '请上传{$0}。',
        _logicrequired: '{$0}输入不完整.',
        _ssid: '请输入标准字符，如 Xiaomi.Luyouqi',
        _macaddr: 'MAC地址格式有误，如ab:cd:ef:11:22:33',
        _weppassword: '密码输入有误',
        _wifipassword: '不能包含中文',
        _ipaddr: 'IP地址由4个 0~255 之间的数字组成，数字之间用点区隔',
        _url: '必须是完整的URL,如 http://miwifi.com'
    };
</script>
<script src="/xuci/assets/js/jquery-1.8.3.js"></script>
<script src="/xuci/assets/js/qwrap.js"></script>
<script src="/xuci/assets/js/common.js"></script>
<script src="/xuci/assets/js/raphael.js"></script>
<script src="/xuci/assets/js/crypto-js/rollups/sha1.js"></script>
<script src="/xuci/assets/js/crypto-js/rollups/aes.js"></script>
<script src="/xuci/assets/js/valid.js"></script>
<script src="/xuci/assets/js/selectbeautify.js"></script>
<script src="/xuci/assets/js/jquery.dialog.js"></script>
<script src="/xuci/assets/js/template-web.js"></script>
<script src="/xuci/assets/js/jq-from.js"></script>
<script>
    (function(){
        var G_FEATURES = $.parseJSON('{"netmode":{"elink":"1"},"hardware":{"disk":"0","usb":"1"},"wifi":{"wifimerge":"1","wifiguest":"1","wifi24":"1","wifi50":"1"},"apps":{"apptc":"0","qos":"1"},"apmode":{"lanapmode":"1","wifiapmode":"1"},"system":{"infileupload":"1","downloadlogs":"0","shutdown":"0","i18n":"0","task":"0"}}');
        window['G_FEATURES'] = G_FEATURES;
    }())
</script>

<script>
    // reboot
    var global_api_reboot = {
        url : '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/reboot',
        param : {"client":"web"}
    };
    function reboot_window( needconfirm ) {
        console.log( needconfirm );
        var reboot = function(){
            $.getJSON( global_api_reboot.url, global_api_reboot.param, function( rsp ) {
                if( rsp.code !== 0 ){
                    $.alert( rsp.msg ).time( 1.5*1000 );
                } else {
                    var ip = rsp.lanIp[0].ip;
                    rebootWait( {
                        lanIp : ip,
                        action : '重启路由器',
                        refresh : true
                    } );
                }
            });
        };
        if ( typeof( needconfirm ) !== "undefined" && needconfirm === false ) {
            reboot();
            return;
        }
        $.confirm('确定重启路由器，重启将断开和灵铱路由器的连接。',function () {
            var dlg = this;
            reboot();
            dlg.close();
            return false;
        });
    }
    // shutdown
    function shutdown_window(){
        $.confirm('是否确定关闭路由器，操作将断开和灵铱路由器的连接。', function () {
            $.getJSON( '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/shutdown', {}, function( rsp ){
                if( rsp.code !== 0 ){
                    $.alert(rsp.msg).time( 1.5*1000 );
                } else {
                    $.loadingDialog({
                        title: '关闭路由器',
                        content: '关机中，请等待路由器指示灯熄灭后再断开电源'
                    });
                }
            });
        });
    }
    //reset
    function reset_window( format ){

        var reset = (function( format ){
            var requestURL = '',
                requestData = {
                    format: format ? 1 : 0
                },
                wait = function(){
                    rebootWait( {
                        action : '恢复出厂设置',
                        refresh : true,
                        lanIp: '192.168.31.1'
                    } );
                },
                clearCookies = function (){
                    var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
                    if ( keys ) {
                        for (var i = keys.length; i--;){
                            document.cookie = keys[i]+'=0;path=/;expires=' + new Date(0).toUTCString();
                        }
                    }
                };

            return function(){
                $.getJSON( requestURL , requestData, function( rsp ) {
                    if ( rsp.code !== 0 ) {
                        $.alert( rsp.msg ).time( 3*1000 );
                    }else{
                        // clear cookies
                        clearCookies();
                        //block wait
                        wait();
                    }
                });
            }
        })( format );

        $.confirm('确定要恢复出厂设置让灵铱路由器回到初始状态？', function(){
            reset();
        });
    }
</script>
<script type="text/tmpl" id="tplrename">
<div class="mod-rename-dlg">
    <div class="form-rename">
        <form action="#" class="form" id="routerNameEdit">
            <div class="form-item">
                <label class="k">路由器名称</label>
                <span class="v">
                    <input type="text" name="routername" id="routername" class="ipt-text" autocomplete="off" datatype="bytetext" maxlength="24" reqMsg="路由器名称" value="{$name}">
                </span>
                <em class="t"></em>
            </div>
            <div class="form-item">
                <label class="k">位置</label>
                <span class="v">
                    <input type="text" name="locale" id="locale" class="ipt-text" autocomplete="off" datatype="bytetext" maxlength="24" reqMsg="路由器位置" value="{$locale}">
                </span>
                <em class="t"></em>
            </div>
            <div class="form-contral">
                <button type="submit" class="btn btn-primary btn-l"><span>保存</span></button>
            </div>
        </form>
    </div>
</div>
</script>
<script type="text/tmpl" id="tplshutdown">
<div class="mod-reboot-dlg">
    <p class="text">关闭路由器将断开其他设备的数据访问和网络连接，之后便可以安全的断开电源。（再次启动需要手工连接电源）</p>
    <button id="shutdownAction" type="button" class="btn btn-primary btn-l"><span>关闭路由器</span></button>
</div>
</script>
<script type="text/tmpl" id="tplreboot">
<div class="mod-shutdown-dlg">
    <p class="text">路由器重启需要等待十几秒或更多时间，重启过程中将会断开网络连接，稍后将自动重新连接网络。</p>
    <button type="button" id="rebootAction" class="btn btn-primary btn-l"><span>重启路由器</span></button>
</div>
</script>
<script type="text/tmpl" id="tpldownloadclient">
<div class="mod-downloadclient-dlg">
    <table>
        <tr>
            <td>
                <i class="ico-down-client ico-down-pc"></i>
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqpc_client.exe">PC客户端</a>
            </td>
            <td class="c1"></td>
            <td class="c2"></td>
            <td>
                <i class="ico-down-client ico-down-mac"></i>
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqmac_client.dmg">MAC客户端</a>
            </td>
        </tr>
        <tr class="last">
            <td>
                <i class="ico-down-client ico-down-andriod"></i>
            
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqapp_dev.apk">Android客户端</a>

            </td>
            <td class="c1"></td>
            <td class="c2"></td>
            <td>
                <i class="ico-down-client ico-down-iphone"></i>
                <a href="https://itunes.apple.com/cn/app/id859962702?mt=8&ls=1">iPhone客户端</a>
            </td>
        </tr>
    </table>
</div>
</script>
<script>
    var Encrypt = {
        key: 'a2ffa5c9be07488bbb04a3a47d3c5f6a',
        iv: '64175472480004614961023454661220',
        nonce: null,
        init: function(){
            var nonce = this.nonceCreat();
            this.nonce = nonce;
            return this.nonce;
        },
        nonceCreat: function(){
            var type = 0;
            var deviceId = '34:de:1a:96:49:43';
            var time = Math.floor(new Date().getTime() / 1000);
            var random = Math.floor(Math.random() * 10000);
            return [type, deviceId, time, random].join('_');
        },
        oldPwd : function(pwd){
            return CryptoJS.SHA1(this.nonce + CryptoJS.SHA1(pwd + this.key).toString()).toString();
        },
        newPwd: function(pwd, newpwd){
            var key = CryptoJS.SHA1(pwd + this.key).toString();
            key = CryptoJS.enc.Hex.parse(key).toString();
            key = key.substr(0, 32);
            key = CryptoJS.enc.Hex.parse(key);
            var password = CryptoJS.SHA1(newpwd + this.key).toString();
            var iv = CryptoJS.enc.Hex.parse(this.iv);
            var aes = CryptoJS.AES.encrypt(
                password,
                key,
                {iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
            ).toString();
            return aes;
        }
    };

    var pingRouter = function( on, off, ip ){
        var online = on || function(){},
            offline = off || function(){},
            host = ip || location.host,
            time = 5000,
            timecounter = 0,
            img = null,
            wait = function(){
                console.log('pingRouter:wait');
                offline();
            },
            done = function(){
                console.log('pingRouter:done');
                window.clearInterval( timer );
                online();
            },
            loadImg = function( onload, onerror ){
                img = new Image();
                img.onload = onload;
                img.onerror = onerror;
                img.src = imgUrl+'?' + (+new Date());
            },
            timer = window.setInterval(function() {

                if ( 'onLine' in navigator ) {
                    if ( navigator.onLine ) {
                        loadImg(
                            function(){
                                done();
                            }, function(){
                                wait();
                            }
                        );
                    } else {
                        wait();
                    }
                }else{
                    loadImg(function(){
                        done();
                    }, function(){
                        wait();
                    });
                }
            }, time );
    };

    var rebootWait = function ( opt ) {
        var action = opt.action,
            ip = opt.lanIp || window.location.host,
            refresh = opt.refresh || false,
            tStart = ( +new Date() ),
            tUse,
            dlgRebootWait = $.loadingDialog({
                title : '重启中...',
                content : '操作生效，等待设备重启...'
            }),
            online = function(){
                dlgRebootWait.content( '操作生效,重启成功！' );
                dlgRebootWait.time( 3*1000 );
                if( refresh ){
                    window.setTimeout( 'window.top.location.href="http://'+ip+'";',3000 );
                }
            },
            offline = function(){
                tUse = Math.round( ( ( +new Date() ) - tStart ) / 1000 );
                if ( tUse > 150 ) {
                    dlgRebootWait.content( '自动连接路由器失败，请检查无线或者网线是否连接正确。' );
                    return;
                }
                dlgRebootWait.content( action + ', 等待自动跳转... 用时{$time}秒'.tmpl({time: tUse}) );
            };

        window.setTimeout( function(){
            pingRouter( online, offline, ip );
        }, 1000 * 60 );
    };

    (function( $ ){

        function formInit( container ) {
            var clsInput = 'form-item form-item-input',
                clsEmpty = 'form-item form-item-empty',
                clsDisabled = 'form-item-disabled',
                clsError = 'form-item-err',
                clsPassword = 'form-item-pwd';

            container = container || 'body';
            $(container).find( '.form-item input' ).each(function(){
                var me = this,
                    $me = $( me ),
                    parent = $( me.parentNode.parentNode ),
                    label = parent.find( '.k' ),
                    offsetX = $me.position().left;
                if ( !( this.type == 'text' || this.type == 'password' ) ) {
                    return;
                }
                // some input do not need init
                if ($me.hasClass('no-init')) {
                    return;
                }
                if ( me.value !=='' ) {
                    parent[0].className = clsInput;
                } else {
                    parent[0].className = clsEmpty;
                    if ( offsetX > 0 ) {
                        label.css({ 'left': offsetX + 10 });
                    }
                }
                if ( me.disabled ) {
                    parent.addClass( clsDisabled );
                }
                if ( $me.attr('data-type') === 'password' ) {
                    parent.addClass( clsPassword );
                    parent.append( '<i class="bt-showpwd bt-showpwd-off"></i>' );
                }

                label.on( 'click', function(e){
                    try {
                        me.focus();
                    } catch ( ex ) {}
                });

            });
            var focusHandler = function(){
                if ( !( this.type == 'text' || this.type == 'password' ) ) {
                    return;
                }
                var me = $( this ),
                    parent = $( this.parentNode.parentNode ),
                    label = parent.find( '.k' ),
                    t = parent.find( '.t' ),
                    classname;
                if (me.hasClass('no-init')) {
                    return;
                }
                if ( parent.hasClass( clsPassword ) ) {
                    classname = clsInput + ' ' + clsPassword;
                } else {
                    classname = clsInput;
                }
                if ( parent.hasClass( clsError ) ) {
                    t.hide();
                }
                label.css({ 'left': 'auto' });
                label.hide();
                parent[0].className = classname;
            };
            var blurHandler = function(){
                var me = this,
                    $me = $( me ),
                    parent = $( me.parentNode.parentNode ),
                    classname,
                    label = parent.find( '.k' ),
                    offsetX = $me.position().left;
                if ( !( this.type == 'text' || this.type == 'password' ) ) {
                    return;
                }
                if ($(this).hasClass('no-init')) {
                    return;
                }
                label.show();
                if ( me.value == '' ) {
                    if ( parent.hasClass( clsPassword ) ) {
                        classname = clsEmpty + ' ' + clsPassword;
                    } else {
                        classname = clsEmpty;
                    }
                    if ( offsetX > 0 ) {
                        label.css({ 'left': offsetX + 10 });
                    } else {
                        label.css({ 'left': 12 });
                    }
                    parent[0].className = classname;
                }
            };
            var  addInputEvent = function() {
                $(container).find( '.form-item input' )
                    .on( 'focus', focusHandler )
                    .on( 'blur', blurHandler );
            };

            var  delInputEvent = function() {
                $(container).find( '.form-item input' ).off( 'focus', focusHandler );
                $(container).find( '.form-item input' ).off( 'blur', blurHandler );
            };
            // del password event
            $( 'body' ).undelegate( '.bt-showpwd', 'click' );
            $( 'body' ).delegate( '.bt-showpwd', 'click', function(e) {
                console.log( 'showpwd' );
                var me = this,
                    meclass = 'bt-showpwd',
                    formItem = $(this).closest('.form-item'),
                    input = formItem.find('input'),
                    inputValue = input.val(),
                    inputWrap = formItem.find('.v'),
                    newinput = '',
                    inputHTML = inputWrap.html();

                if( input.attr('type') == 'password' ){
                    newinput = inputHTML.replace( /type\s*=\s*('|")?password('|")?/ig, 'type="text"');
                    inputWrap.html( newinput ).find('input')[0].value = inputValue;
                    me.className = meclass + ' bt-showpwd-on';
                }else{
                    newinput = inputHTML.replace( /type\s*=\s*('|")?text('|")?/ig, 'type="password"');
                    inputWrap.html( newinput ).find('input')[0].value = inputValue;
                    me.className = meclass + ' bt-showpwd-off';
                }

                setTimeout( function() {
                    delInputEvent();
                    addInputEvent();
                }, 0 );
            });

            addInputEvent();
        }

        $.formInit = formInit;

    })(jQuery);

    /**
     * byte format
     */
    function byteFormat(number, precision, isarray){
        var val,
            label,
            ret;
        precision = precision || 100,
            isarray = isarray || false;
        if (number > 1024 * 1024 * 1024) {
            val = Math.floor( number / 1024 / 1024 / 1024 * precision ) / precision;
            label = 'GB';
        } else if (number > 1024 * 1024 && number < 1024 * 1024 * 1024){
            val = Math.floor( number / 1024 / 1024 * precision ) / precision;
            label = 'MB';
        }else{
            val = Math.floor( number / 1024 * precision ) / precision;
            label = 'KB';
        }

        if (isarray) {
            ret = [val, label];
        }else{
            ret = val + label;
        }

        return ret;
    }


    function secondToHour(time){
        var pint = function(num){
                return parseInt(num, 10);
            },
            hour = pint(time / 3600.0),
            minute = pint((parseFloat(time / 3600.0) - hour) * 60),
            second = pint(time) - hour * 3600 - minute * 60,
            format = hour + '小时' + minute + '分' + second + '秒';
        return format;
    }

    function secondToDate(second) {
        var time = parseFloat(second),
            pint = function(num){
                return parseInt(num, 10);
            },
            day;
        if (time !== null && time !== "") {
            if (time > 60 && time < 60 * 60) {
                time = pint(time / 60.0) + '分' + pint((parseFloat(time / 60.0) - pint(time / 60.0, 10)) * 60) + '秒';
            }
            else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                time = secondToHour(time);
            }else if (time >= 24* 60 * 60 ) {
                day = pint(time  / (3600.0 * 24) );
                time = time - (day * 3600 * 24);
                time =  day + '天 ' + secondToHour(time);
            }
            else {
                time = pint(time) + '秒';
            }
        }
        return time;
    }

    (function( $ ){
        function pint(num){
            return parseInt(num, 10);
        }

        function secondToHour(time){
            var hour = pint(time / 3600.0),
                minute = pint((parseFloat(time / 3600.0) - hour) * 60),
                second = pint(time) - hour * 3600 - minute * 60,
                format = hour + '小时' + minute + '分' + second + '秒';
            return format;
        }

        function secondToDate(second) {
            var time = parseFloat(second),
                day;
            if (time !== null && time !== "") {
                if (time > 60 && time < 60 * 60) {
                    time = pint(time / 60.0) + '分' + pint((parseFloat(time / 60.0) - pint(time / 60.0, 10)) * 60) + '秒';
                }
                else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    time = secondToHour(time);
                }else if (time >= 24* 60 * 60 ) {
                    day = pint(time  / (3600.0 * 24) );
                    time = time - (day * 3600 * 24);
                    time =  day + '天' + secondToHour(time);
                }
                else {
                    time = pint(time) + '秒';
                }
            }
            return time;
        }

        function secondToDate2(second) {
            var time = parseFloat(second),
                num = 0,
                unit = '天';
            console.log( second, time );
            if (!isNaN(time)) {
                if (time > 60 && time < 60 * 60) {
                    num = Math.floor(time / 60.0);
                    unit = '分钟';
                } else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    num = Math.floor(time / 3600.0);
                    unit = '小时'
                } else if (time >= 24 * 60 * 60 ) {
                    num = Math.floor( time  / (3600.0 * 24) );
                    unit =  '天';
                } else {
                    num = Math.floor(time);
                    unit = '秒';
                }
            }
            return {
                num: num,
                unit: unit
            };
        }

        $.secondToHour = secondToHour;
        $.secondToDate = secondToDate;
        $.secondToDate2 = secondToDate2;
    })( jQuery );


    $( document ).ajaxSuccess( function( event, xhr, settings ) {
        var rsp = xhr.responseText;
        rsp = $.parseJSON( rsp );
        // console.log(event, xhr, settings);
        var ignore = [
            'api\/xqsystem\/login',
            'api\/xqsystem\/upgrade_rom'
        ];
        for (var i = 0; i < ignore.length; i++) {
            var ignoreTest = new RegExp(ignore[i]);
            // console.log( ignoreTest );
            if ( ignoreTest.test( settings.url ) ) {
                return;
            }
        }
        if ( rsp.code === 401 || rsp.code === 403) {
            document.location.href =  'http://' + location.host;
        }
    } );

    $.sub( 'wait', function( evt, data ){
        var selector = data.id;
        if ( !$.waitStatus) {
            $.waitStatus = {};
        }
        $.waitStatus[selector] = $( selector ).text();
        $( selector ).addClass('btn-primary-disabled').prop( 'disabled' , true ).find('span').text( '处理中...' );
    } );

    $.sub( 'done', function( evt, data ){
        var selector = data.id,
            text = $.waitStatus[selector];
        $( selector ).removeClass('btn-primary-disabled').prop( 'disabled' , false ).find('span').text( text );
    } );

    $.sub( 'loading:start', function(){
        var isLoading = $('html').hasClass('isloading');
        if ( isLoading ) {
            return;
        }
        var tplMask = '<div id="panel-loading-mask" class="panel-mask" style="position:fixed;left:0;top:0;style:none;"></div>',
            tplLoading = ''
                +'<div id="panel-loading" class="panel-loading" style="style:none;">'
                +   '<img src="/img/loading2.gif">'
                +'</div>',
            $mask = $( tplMask ),
            $loading = $( tplLoading ),
            zIndex = 10000;
        $mask.css({
            'z-index': zIndex,
            width: $(window).width() + 'px',
            height: $(window).height() + 'px'
        });
        $loading.css({'z-index': zIndex + 1});
        $mask.appendTo( document.body ).show();
        $loading.appendTo( document.body ).show();
        $('html').addClass('isloading');
    } );

    $.sub( 'loading:stop', function(){
        $('html').removeClass('isloading');
        $('#panel-loading, #panel-loading-mask').remove();
    });

    // dialog block loading
    (function( $ ){
        $.loadingDialog = function( config ){
            var mix = ObjectH.mix,
                _config = config || {
                    title: '',
                    content: ''
                },
                conf = mix( _config, {
                    width: 390,
                    padding:'25px 30px',
                    title: config.title,
                    content: '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: config.content}),
                    cancel: false
                }, true ),
                dialog = $.dialog( conf );

            var oldcontent = dialog.content;
            dialog.content = function( cont ){
                var _cont = '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: cont});
                return oldcontent.call( dialog, _cont);
            };
            return dialog;
        }
    })(jQuery);

    // dialog alert
    (function( $ ){
        $.alert = function( content, ok ){
            ok = ok || function(){};
            return $.dialog({
                width: 390,
                padding:'25px 30px',
                title: '提示信息',
                content: content,
                ok: ok,
                cancel: false
            });
        }
    })(jQuery);

    // dialog confirm
    (function( $ ){
        $.confirm = function( content, ok, cancel ){
            var _cancel = cancel || function(){};
            return $.dialog({
                width: 390,
                padding:'25px 30px',
                title: '确认信息',
                content: content,
                ok: ok,
                cancel: _cancel,
                lock: true
            });
        }
    })(jQuery);

    // wechat code dialog
    $(function(){
        $( '#wechatcode' ).click(function( e ){
            e.preventDefault();
            var $this = $( this ),
                href = $this.attr( 'href' );
            $.dialog({
                title: '官方微信',
                content: '<img width="200" src="'+ href +'">',
                width: 250,
                lock: true
            });
        });
    });


    // set sys language
    (function($){
        $.i18nSet = function( el ){
            var $lan = $( el ),
                apiGetLan = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/get_languages',
                apiSetlan = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/set_language',
                dtd = $.Deferred();

            $.get(apiGetLan, function( rsp ){
                var rsp = $.parseJSON( rsp );
                var selectContent = [];
                if ( rsp.code == 0 ) {
                    for (var i = 0; i < rsp.list.length; i++) {
                        var item = rsp.list[i],
                            selected = item.lang == rsp.lang ? 'selected' : '',
                            option = '<option value="' + item.lang + '" '+ selected +'>' + item['name'] + '</option>';
                        // clear old conf en item
                        // if ( item.lang != 'en') {
                        selectContent.push(option);
                        // }
                    };
                    $lan.html( selectContent.join('') );
                    dtd.resolve();
                }
            });

            $lan.on('change', function( e ){
                var el = this,
                    val = $(this).val();
                $.pub('loading:start');
                $.post(apiSetlan, {language: val}, function( rsp ){
                    var rsp = $.parseJSON( rsp );
                    if ( rsp.code == 0 ) {
                        location.reload( 1 );
                    } else {
                        $.alert( rsp.msg );
                    }
                    $.pub('loading:stop');
                });
            });

            return dtd.promise();
        };
    }(jQuery));

    // global event
    (function($){
        var dlgReboot,
            dlgShutdown,
            dlgRouterName;
        function getNotice(){
            $.getJSON('/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/messages', function(rsp){
                if ( rsp.code == 0 ) {
                    var classname;
                    if ( rsp.count > 0 ) {
                        classname = 'ico-notice-new';
                    } else {
                        classname = 'ico-notice';
                    }
                    $('#sysnotice')[0].className = classname;
                    var msgMap = {
                        '1': '<p>检测到最新版本为{$version}，<a href="/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/web/setting/upgrade">点击此处立即升级</a>。</p>',
                        '3': '<p>5G Wi-Fi启动失败，<a target="_blank" href="http://www.mi.com/service/contact/">请联系灵铱客服解决</a></p>',
                        '4': '<p>检测到与上级路由器存在IP冲突，建议切换到<a href="/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/web/setting/wan#netmode">有线中继模式</a>或者<a href="#" id="ipconflict" data-ip="{$ip}">避让IP冲突</p>'
                    };
                    var msgHTML = [];
                    for (var i = rsp.messages.length - 1; i >= 0; i--) {
                        msgHTML.push(msgMap[rsp.messages[i].type].tmpl(rsp.messages[i].data));
                    };
                    $('#noticebar .content').html( msgHTML.join('') );

                    if ( rsp.count > 0 ) {
                        $('#sysnotice').trigger('click');
                    }
                }
            });
        }
        function reNameHandler(e){
            e.preventDefault();
            $.getJSON('/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/router_name')
                .done(function( rsp ){
                    if ( rsp.code == 0 ) {
                        var html = StringH.tmpl($('#tplrename').html() , {
                            locale: StringH.encode4HtmlValue(rsp.locale),
                            name: StringH.encode4HtmlValue(rsp.name)
                        });
                        dlgRouterName = $.dialog({
                            width: 390,
                            title: '修改路由器名称',
                            content: html,
                            lock: true
                        });
                        setTimeout(function(){
                            $.formInit('.mod-rename-dlg');
                            $.selectBeautify({container: '.mod-rename-dlg'});
                        }, 100);
                    }
                });
        }
        function downloadClientHandler(e){
            e.preventDefault();
            $.dialog({
                width: 390,
                title: '下载客户端',
                content: $('#tpldownloadclient').html(),
                lock: true
            });
            setTimeout(function(){
                $('.onlineimg').each(function(){
                    var img = new Image();
                    var el = this;
                    var remote = el.src;
                    var local = $(el).attr('src-local');
                    img.onerror = function(){
                        el.src = local;
                    }
                    img.src = remote;
                });
            }, 100);
        }
        function rebootHandler(e){
            e.preventDefault();
            dlgReboot = $.dialog({
                width: 390,
                title: '重启路由器',
                content: $('#tplreboot').html(),
                lock: true
            });
        }
        function shutdownHandler(e){
            e.preventDefault();
            dlgShutdown = $.dialog({
                width: 390,
                title: '路由器关机',
                content: $('#tplshutdown').html(),
                lock: true
            });
        }

        function noticeHandler(e){
            e.preventDefault();
            var that = this,
                $this = $(this),
                pos = $('#userbar').position(),
                right,
                wt = 1160,
                wwt = $(window).width(),
                $arrow = $('#noticebar .ico-arrow');
            if ( $this.hasClass('ico-notice-new') ) {
                // right = wt - pos.left - 20;
                $arrow.css({'right': '10px'});
                $('#noticebar').css({'right': (wwt - wt) /2 });
                $('#noticebar').toggle();
            }
            $('#maskMenu').height($(window).height());
            $('#maskMenu').show();
        }

        function sysmenuHandler(e){
            e.preventDefault();
            var that = this,
                $this = $(this);
            if ( $this.hasClass('s-dropdown') ){
                var ww = $(window).width();
                // var rt = (ww - 1160) / 2;
                var lt = $this.offset().left + $this.outerWidth() - $('#dropmenu').width();
                $('#dropmenu').css({left: lt});
                $('#dropmenu').show();
                that.className = 'name s-dropup';
            }else{
                $('#dropmenu').hide();
                that.className = 'name s-dropdown';
            }
            $('#maskMenu').height($(window).height());
            $('#maskMenu').show();
        }

        function maskHandler(e){
            e.preventDefault();
            $('#noticebar').hide();
            $('#dropmenu').hide();
            $('#maskMenu').hide();
            $('#sysmenu')[0].className = 'name s-dropdown';
        }

        $(function(){
            // notice
            $('#sysnotice').click(noticeHandler);
            // user dropmenu
            $('#sysmenu').click(sysmenuHandler);
            // space click
            $('#maskMenu').click(maskHandler);
            // rename
            $( 'body' ).delegate( '#toRename', 'click', reNameHandler );
            // toDownloadClient
            $( 'body' ).delegate( '#toDownloadClient', 'click', downloadClientHandler );
            // toReboot
            $( 'body' ).delegate( '#toReboot', 'click', rebootHandler );
            // toShutdown
            $( 'body' ).delegate( '#toShutdown', 'click', shutdownHandler);

            $( 'body' ).delegate( '#shutdownAction', 'click', function( e ){
                e.preventDefault();
                dlgShutdown.close();
                shutdown_window();
            } );

            $( 'body' ).delegate( '#rebootAction', 'click', function( e ){
                e.preventDefault();
                dlgReboot.close();
                reboot_window();
            } );

            $( 'body' ).delegate( '#routerNameEdit', 'submit', function( e ){
                e.preventDefault();
                var validator = Valid.checkAll( this );
                var routername = $('#routername').val();
                var locale = $('#locale').val();
                if ( validator ) {
                    $.getJSON('/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/set_router_name',{
                        name: routername,
                        locale: locale
                    }).done(function(rsp){
                        if ( rsp.code == 0 ) {
                            location.reload(1);
                        } else {
                            $.alert( rsp.msg )
                        }
                    });
                }
            } );

            $( 'body' ).delegate('#ipconflict', 'click', function(e){
                e.preventDefault();
                var api = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/r_ip_conflict',
                    ip = $(this).attr('data-ip');
                $.dialog({
                    title: '避让IP冲突',
                    content: '执行此操作，局域网IP将会变更为' + ip + '<br>' +'该过程无线网络会重启，将出现短暂掉线。',
                    lock: true,
                    ok: function(){
                        $.post(api, function(rsp){
                            rsp = $.parseJSON(rsp);
                            if (rsp.code !== 0) {
                                alert(rsp.msg);
                            }
                        });
                    },
                    cancel: function(){}
                });
            });
        });
    })(jQuery);
</script>
<script src="/xuci/assets/js/miwifi-monitor.js"></script>


<script>
    // reboot
    var global_api_reboot = {
        url : '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/reboot',
        param : {"client":"web"}
    };
    function reboot_window( needconfirm ) {
        console.log( needconfirm );
        var reboot = function(){
            $.getJSON( global_api_reboot.url, global_api_reboot.param, function( rsp ) {
                if( rsp.code !== 0 ){
                    $.alert( rsp.msg ).time( 1.5*1000 );
                } else {
                    var ip = rsp.lanIp[0].ip;
                    rebootWait( {
                        lanIp : ip,
                        action : '重启路由器',
                        refresh : true
                    } );
                }
            });
        };
        if ( typeof( needconfirm ) !== "undefined" && needconfirm === false ) {
            reboot();
            return;
        }
        $.confirm('确定重启路由器，重启将断开和灵铱路由器的连接。',function () {
            var dlg = this;
            reboot();
            dlg.close();
            return false;
        });
    }
    // shutdown
    function shutdown_window(){
        $.confirm('是否确定关闭路由器，操作将断开和灵铱路由器的连接。', function () {
            $.getJSON( '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/shutdown', {}, function( rsp ){
                if( rsp.code !== 0 ){
                    $.alert(rsp.msg).time( 1.5*1000 );
                } else {
                    $.loadingDialog({
                        title: '关闭路由器',
                        content: '关机中，请等待路由器指示灯熄灭后再断开电源'
                    });
                }
            });
        });
    }
    //reset
    function reset_window( format ){

        var reset = (function( format ){
            var requestURL = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/reset',
                requestData = {
                    setcfg: format ? 1 : 0
                },
                wait = function(){
                    rebootWait( {
                        action : '恢复出厂设置',
                        refresh : true,
                        lanIp: '192.168.31.1'
                    } );
                },
                clearCookies = function (){
                    var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
                    if ( keys ) {
                        for (var i = keys.length; i--;){
                            document.cookie = keys[i]+'=0;path=/;expires=' + new Date(0).toUTCString();
                        }
                    }
                };

            return function(){
                $.getJSON( requestURL , requestData, function( rsp ) {
                    if ( rsp.code !== 0 ) {
                        $.alert( rsp.msg ).time( 3*1000 );
                    }else{
                        // clear cookies
                        clearCookies();
                        //block wait
                        wait();
                    }
                });
            }
        })( format );

        $.confirm('确定要恢复出厂设置让灵铱路由器回到初始状态？', function(){
            reset();
        });
    }
</script>


<!--<script type="tmpl/template" id="uploadform">-->
<!--<p>路由器正常工作情况下建议使用系统升级检测进行升级，在当系统无法升级或需要降级到前一版本时使用手动上传rom包进行升级。</p>-->
<!--<div class="uploadprogress" id="uploadprogress" style="display:none;">-->
    <!--<div class="progress-text">0%</div>-->
    <!--<div class="progress"><div class="value"></div></div>-->
<!--</div>-->
<!--<div class="uploadloading" id="uploadloading" style="display:none;">-->
    <!--<div class="loading-bar"></div>-->
<!--</div>-->
<!--<form id="formid" enctype="multipart/form-data" method="post" action="/upload" target="rfFrame">-->
    <!--<div class="item">-->
        <!--<label class="k">请选择固件:</label>-->
        <!--<span class="v">-->
            <!--<input type="file" name="firmware" id="image" />-->
        <!--</span>-->
        <!--<em class="t"></em>-->
    <!--</div>-->
    <!--<div class="item item-contral">-->
        <!--<button type="button" class="btn btn-block btn-primary-disabled" id="uploadFormBtn" disabled><span>开始升级</span></button>-->
    <!--</div>-->
<!--</form>-->
 <!--<iframe id="rfFrame" name="rfFrame" src="about:blank" style="display:none;"></iframe>-->
<!--</script>-->

<script type="tmpl/text" id="selectBackupList">
<div class="dialog-select-list">
    <p class="gray">可选备份</p>
    <ul>
    
        <li><label><input type="checkbox" name="item" data-key="mi_basic_info" checked="true" /> <span class="name">路由器名和管理密码</span></label></li>
    
        <li><label><input type="checkbox" name="item" data-key="mi_network_info" checked="true" /> <span class="name">上网设置(拨号方式和宽带帐号密码等)</span></label></li>
    
        <li><label><input type="checkbox" name="item" data-key="mi_wifi_info" checked="true" /> <span class="name">wifi设置(wifi名称和密码等)</span></label></li>
    
        <li><label><input type="checkbox" name="item" data-key="mi_lan_info" checked="true" /> <span class="name">DHCP服务和局域网IP设置</span></label></li>
    
        <li><label><input type="checkbox" name="item" data-key="mi_arn_info" checked="true" /> <span class="name">无线访问黑白名单</span></label></li>
    
    </ul>
    <a href="#" id="btnstartbackup" class="btn btn-primary btn-l"><span>开始备份</span></a>
</div>
</script>
<script type="tmpl/text" id="backupFail">
<div class="dialog-backup-tips">
    <p >由于 <span></span> 原因，路由器设置备份失败！</p>
    <a href="#" class="btn btn-primary btn-l"><span>重试</span></a>
</div>
</script>
<script type="tmpl/text" id="configUpload">
<div class="config-upload">
    <form class="form form-upload" name="configuploadForm" id="configuploadForm" method="post" enctype="multipart/form-data" >
    <div class="item">
        <label class="k">请选择备份文件</label>
        <span class="v">
            <input type="file" name="image" id="configimage" />
        </span>
        <em class="t"></em>
    </div>
    <div class="item item-contral">
        <button type="button" class="btn btn-block btn-primary-disabled" id="configuploadFormBtn" disabled><span>开始恢复</span></button>
    </div>
    </form>
</div>
</script>
<script type="tmpl/text" id="selectRestoreList">
<div class="dialog-select-list">
    <p class="gray">可选恢复的项目</p>
    <ul>

    </ul>
    <a href="#" id="btnstartrestore" class="btn btn-primary btn-l"><span>恢复</span></a>
</div>
</script>
<script type="tmpl/text" id="restoresucc">
<div class="dialog-backup-tips">
    <p >路由器设置恢复成功，重启路由器即可生效！ </p>
    <a href="#" class="btn btn-primary btn-l"><span>重启路由器</span></a>
</div>
</script>
<script type="tmpl/text" id="restorefail">
<div class="dialog-backup-tips">
    <p >由于 <span></span> 原因，路由器设置备份失败！</p>
    <a href="#" class="btn btn-primary btn-l"><span>重试</span></a>
</div>
</script>
<script type="tmpl/text" id="resettip">
<div class="dialog-reset-tips">
    <p >恢复出厂设置操作会抹掉当前路由器的所有设置，建议您先进行配置备份再恢复出厂设置。</p>
    <div class="btns">
        <a href="#" id="toconfigbackup" class="btn btn-primary btn-m"><span>备份路由器设置</span></a>
        <a href="#" id="toresetwindow" class="btn btn-primary btn-m"><span>直接恢复出厂设置</span></a>
    </div>
</div>
</script>
<script type="tmpl/text" id="tpltimezone">
<div class="dialog-timezone">
    <div class="clearfix">
        <div class="form-item-select">
            <label class="k"></label>
            <span class="v"><select name="timezone" id="timezone" class="beautify"></select></span>
        </div>
    </div>

    <div>
        <button type="button" id="btnTimezoneSubmit" class="btn btn-primary btn-l"><span>确定</span></button>
    </div>
</div>
</script>
<script type="tmpl/text" id="tpldatetime">
<div class="dialog-datetime">
    <div>
        <span><select name="year" id="year" style="width:80px;"></select> 年</span>
        <span><select name="month" id="month" style="width:80px;"></select> 月</span>
        <span><select name="day" id="day" style="width:80px;"></select> 日</span>
    </div>
    <div>
        <span><select name="hour" id="hour" style="width:80px;"></select> 时</span>
        <span><select name="minute" id="minute" style="width:80px;"></select> 分</span>
        <span><select name="second" id="second" style="width:80px;"></select> 秒</span>
    </div>
    <p><button type="button" id="btnGetNowDate" class="btn btn-dft btn-l"><span>当前时间</span></button></p>
    <p><button type="button" id="btnDatetimeSubmit" class="btn btn-primary btn-l"><span>确定</span></button></p>
</div>
</script>
<script>
    // upload method
    (function( $ ){
        $.fn.ajaxUpload = function(options){

            var that = this,
                uploadbyiframe = function( options ){
                    var d = new Date().getTime(),
                        iframeName = 'iframeUpload' + d,
                        iframeContents,
                        iframe = $('<iframe name="rfFrame" id="rfFrame" style="display: none" />');
                    $("body").append(iframe);

                    var form = $(that);
                    form.attr("action", options.url);
                    form.attr("method", "post");
                    form.attr("enctype", "multipart/form-data");
                    form.attr("encoding", "multipart/form-data");
                    form.attr("target", iframeName);
                    form.submit();

                    form.hide();
                    $('#uploadloading').show();
                    $(document.getElementById(iframeName))
                        .load(function () {
                            try{
                                iframeContents = document.getElementById(iframeName).contentWindow.document.body.innerHTML;
                                var rsp = iframeContents.match(/^\{.*?\}/);
                                if ( rsp ) {
                                    rsp = $.parseJSON(rsp[0]);
                                    options.success(rsp);
                                } else {
                                    options.error();
                                    form.show();
                                    $('#uploadloading').hide();
                                }
                            } catch( e ) {
                                options.error();
                                form.show();
                                $('#uploadloading').hide();
                            }
                        })
                        .error(function(){
                            options.error();
                            form.show();
                            $('#uploadloading').hide();
                        });
                    return false;

                },
                uploadbyajax = function( options ) {
                    var form = $(that);
                    var formData = new FormData( form[0] );
                    var progressBar = form.find( '.progress' );
                    var progressBar = $('#uploadprogress');
                    var progressBarVal = progressBar.find( '.progress .value' );
                    var progressBarText = progressBar.find( '.progress-text' );

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', options.url, true);
                    xhr.onload = function(e) {
                        if ( xhr.status === 200) {
                            var rsp = $.parseJSON(e.target.responseText);
                            options.success(rsp);
                        } else {
                            options.error();
                            form.show();
                            progressBar.hide();
                        }
                    };
                    xhr.onerror = function(e) {
                        options.error();
                        form.show();
                        progressBar.hide();
                    };
                    xhr.upload.onprogress = function ( e ) {
                        console.log( e, progressBar );
                        if (e.lengthComputable) {
                            form.hide();
                            progressBar.show();
                            var pct = (e.loaded / e.total) * 100;
                            progressBarVal.css({
                                width: pct + '%'
                            });
                            progressBarText.text( parseInt(pct, 10) + '%' );
                        }
                    };
                    xhr.send(formData);  // multipart/form-data
                };

            if ( window.FormData ) {
                uploadbyajax( options );
            } else {
                uploadbyiframe( options );
            }
        };
    })(jQuery);
    //check ota
    $.sub( 'upgrade:check', function() {
        var requestData = {},
            requestURL = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/check_rom_update',
            tplChecking = '当前版本{$romVersion}，{$ret}',
            tplHasnew = '发现新版本,升级包大小为{$size}，请立即升级。';
        $.getJSON( requestURL, requestData, function(rsp) {
            if(rsp.code == 0){
                if( rsp.needUpdate == 1 ){
                    $( '#upgradeinfo' ).html( tplHasnew.tmpl( {
                        size: '<em class="em">' + byteFormat( rsp.fileSize ) + '</em>'
                    } ) );
                    $( '.hasnewver' ).show();
                    $( '.logs' ).show();
                } else {
                    $( '#upgradeinfo' ).html( tplChecking.tmpl( {
                        romVersion: '<em class="em">2.25.122</em>',
                        ret: '你的版本是最新的，无需升级。'
                    } ) );
                    $(".hasnewver").hide();
                }

                // if ( rsp.changeLog && rsp.changeLog != "" ){
                //     $( '#changelog' ).html( rsp.changeLog );
                // }
                if (rsp.changelogUrl && rsp.changelogUrl != ""){
                    $('#changelogUrl').attr('src', rsp.changelogUrl);
                    $('#changelogUrl').load(function(){
                        $('#changelog').show();
                    });
                }
            } else {
                $( '#upgradeinfo' ).html( tplChecking.tmpl( {
                    romVersion: '<em class="em">2.25.122</em>',
                    ret: '检查失败，网络繁忙请刷新页面重试。'
                } ) );
            }
        })
    });

    $.sub( 'upgrade:download', function() {

        $( '#btnUpgread' ).on( 'click', function( e ){
            e.preventDefault();
            var url = $(this).attr('href');
            var getUsb = function(){
                return $.ajax({
                    url: '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/usbmode',
                    type: 'POST',
                    dataType: 'json'
                });
            };
            var dlgUpgradeConfirm = $.confirm(
                '<div class="mod-downflash">请注意：升级将会使所有已连接设备的网络中断，升级过程中请勿断开路由器电源或关闭本页面！</div>',
                function() {
                    window.location.href = url;
                }
            );
        });
    });

    $.sub( 'upgrade:upload', function() {

        function usbservice(enbale) {
            if ( parseInt(G_FEATURES['hardware']['disk'], 10) == 1) {
                return {
                    done: function( f ){ f(); }
                };
            }
            var requestURL = '',
                requestData = {'enable': enbale};

            return $.ajax({
                url: requestURL,
                type: 'get',
                dataType: 'json',
                data: requestData
            });
        }

        function uploadfile(){
            var options  = {
                url:"/upload",   //同action
                type:'post',
                beforeSend:function(xhr){//请求之前
                    alert("正在上传固件");
                },
                success:function(data)
                {
                    console.log(data);
                },

                complete:function(xhr){//请求完成
                    alert('上传成功,请等待1分钟后手动刷新页面');
                },
                error: function(xhr,status,msg){
                    console.log('错误')
                }
            };
            $("#formid").ajaxSubmit(options);
        }

        $( 'body' ).delegate( '#image', 'change', function( e ){

            $( '#uploadFormBtn' ).on( 'enable', function( e, data ) {
                if ( data.disabled ) {
                    this.className = 'btn btn-primary-disabled btn-block';
                    this.disabled = true;
                } else {
                    this.className = 'btn btn-primary btn-block';
                    this.disabled = false;
                }
            });

            var image = $( '#image' );
            var err = $( '#uploadForm .t' );
            var item = $( '#uploadForm .item' ).eq( 0 );
            if ( image.val() == '' ) {
                err.html( '你未选择文件，请重新选择' ).show();
                item.addClass( 'item-err' );
                $( '#uploadFormBtn' ).trigger( 'enable', {disabled: true} );
                return false;
            }
            var val = image.val();
            var ext = val.substring( val.lastIndexOf( '.' ) + 1 );
            ext = $.trim( ext );
            var validExt = ext == 'bin' || ext == 'BIN';
            if ( !validExt ) {
                err.html( '文件格式错误，请重新选择' ).show();
                item.addClass( 'item-err' );
                $( '#uploadFormBtn' ).trigger( 'enable', {disabled: true} );
                return false;
            }
            err.hide();
            item.removeClass( 'item-err' );
            $( '#uploadFormBtn' ).trigger( 'enable', {disabled: false} );
        } );

        var uploadHander = $.throttle(function( e ) {
            e.preventDefault();
            var uploadform = $( '#uploadform' ).html();
            $.dialog({
                id: 'usbcheck_upload',
                width: 390,
                title: '手动升级',
                content: '<div class="mod-uploadflash">' + uploadform + '</div>'
            }).lock();
        }, 1000);

        $( '#btnUpload' ).on( 'click', uploadHander);

        $( 'body' ).delegate( '#button', 'click', function( e ){
            e.preventDefault();
            uploadfile();
            return false;
        });

        $.sub( 'uploadlog', function(){
            // upload logs
            $( '#btnUploadlog' ).on( 'click', function( e ){
                e.preventDefault();
                var requestURL = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/xqsystem/upload_log',
                    requestData = {};

                $.pub( 'wait', {id: '#btnUploadlog'} );

                $.getJSON( requestURL, requestData, function( rsp ){
                    if( rsp.code===0 ){
                        $.alert( '日志上传成功');
                    } else {
                        $.alert( rsp.msg );
                    }
                    $.pub( 'done', {id: '#btnUploadlog'} );
                })
            } );

            // download log
            $( '#btnDownloadlog' ).on( 'click', function( e ){
                e.preventDefault();
                var requestURL = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/sys_log',
                    requestData = {};

                $.pub( 'wait', {id: '#btnDownloadlog'} );

                $.getJSON( requestURL, requestData, function( rsp ){
                    if( rsp.code===0 ){
                        window.top.location.href = 'http://' + rsp.path;
                    } else {
                        $.alert( rsp.msg );
                    }
                    $.pub( 'done', {id: '#btnDownloadlog'} );
                })
            });
        } );

        $.sub( 'reset', function(){
            // reset
            $( '#btnReset' ).on( 'click', function( e ){
                e.preventDefault();
                // reset_window();
                $.pub( 'reset:tip' )
            } );
        } );

        $.sub( 'langset', function(){
            $.i18nSet('#lang').done(function(){
                $.selectBeautify();
            });
        } );
    });

    $.sub( 'reset:tip', function(){
        var tipDialog = $.dialog({
            title: '提示',
            content: $('#resettip').html(),
            lock: true,
            width: 390,
            initialize: function(){
                $('#toconfigbackup').on('click', function(e){
                    e.preventDefault();
                    tipDialog.close();
                    $.pub( 'config:backup' );
                });
                $('#toresetwindow').on('click', function(e){
                    e.preventDefault();
                    tipDialog.close();
                    reset_window();
                });
            }
        });
    } );

    $.sub( 'config:backup', function(){
        alert('备份');
    });

    $.sub( 'config:backupfail', function(evt, data){
        var msg = data.msg;
        var failDialog = $.dialog({
            title: '备份路由器设置',
            content: $('#backupFail').html(),
            lock: true,
            width: 390,
            initialize: function(){
                $('.dialog-backup-tips p span').text( msg );
                $('.dialog-backup-tips .btn').on('click', function(e){
                    e.preventDefault();
                    failDialog.close();
                    $.pub( 'config:backup' );
                });
            }
        });
    });

    $.sub( 'config:restore', function(evt, data){
        var keys = data.keys;
        var tpl = '<li><label><input type="checkbox" name="item" data-key="{$k}" checked="true" /> <span class="name">{$v}</span></label></li>';
        var html = [];
        var li = '';
        for(var key in keys ){
            li = StringH.tmpl(tpl, {
                k: key,
                v: keys[key]
            });
            html.push( li );
        }

        var showRestoreList = $.dialog({
            title: '从备份恢复路由器设置',
            content: $('#selectRestoreList').html(),
            lock: true,
            width: 390,
            initialize: function(){
                $('.dialog-select-list ul').html( html.join('') );
            }
        });

        $('#btnstartrestore').on('click', function(e){
            e.preventDefault();
            var requestURL = '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/c_restore';
            var requestData = {};
            var keys = [];
            var inputed = $('.dialog-select-list input:checked');
            if( inputed.length > 0 ){
                $( inputed ).each(function(index, item){
                    keys.push( $(item).attr('data-key') );
                });
                keys = keys.join(',');
                requestData.keys = keys;
                $.getJSON( requestURL, requestData, function( rsp ){
                    showRestoreList.close();
                    if( rsp.code==0 ){
                        $.pub( 'config:restoresucc' );
                    } else {
                        $.pub( 'config:restorefail', {msg: rsp.msg} );
                    }
                });
            }else{
                $.alert('至少选择1个');
            }
        });
    });

    $.sub( 'config:restoresucc', function(evt, data){

        var succDialog = $.dialog({
            title: '从备份恢复路由器设置',
            content: $('#restoresucc').html(),
            lock: true,
            width: 390,
            initialize: function(){
                $('.dialog-backup-tips .btn').on('click', function(e){
                    e.preventDefault();
                    succDialog.close();
                    reboot_window();
                });
            }
        });
    });

    $.sub( 'config:restorefail', function(evt, data){
        var msg = data.msg;
        var failDialog = $.dialog({
            title: '从备份恢复路由器设置',
            content: $('#restorefail').html(),
            lock: true,
            width: 390,
            initialize: function(){
                $('.dialog-backup-tips p span').text( msg );
                $('.dialog-backup-tips .btn').on('click', function(e){
                    e.preventDefault();
                    failDialog.close();
                    $.pub( 'config:upload' );
                });
            }
        });
    });

    $.sub( 'config:upload', function(){
        var showUpload = $.dialog({
            title: '从备份恢复路由器设置',
            content: $('#configUpload').html(),
            lock: true,
            width: 390
        });
        function uploadfile(){

            var options = {
                type: 'post',
                dataType: "json",
                url: '/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/c_upload',
                success: function( rsp ) {
                    console.log( rsp );
                    if( rsp.code == 0 ){
                        showUpload.close();
                        $.pub( 'config:restore', rsp.des );
                    }else{
                        $.alert( rsp.msg );
                    }
                },
                error: function() {
                    $.alert( '系统错误，请重试。' ).lock();
                    $('#configuploadFormBtn').show();
                }
            };
            $('#configuploadFormBtn').hide();
            $( '#configuploadForm' ).ajaxUpload( options );
        }
        $( 'body' ).delegate( '#configimage', 'change', function( e ){
            $( '#configuploadFormBtn' ).on( 'enable', function( e, data ) {
                if ( data.disabled ) {
                    this.className = 'btn btn-primary-disabled btn-block';
                    this.disabled = true;
                } else {
                    this.className = 'btn btn-primary btn-block';
                    this.disabled = false;
                }
            });

            var image = $( '#configimage' );
            var err = $( '#configuploadForm .t' );
            var item = $( '#configuploadForm .item' ).eq( 0 );
            if ( image.val() == '' ) {
                err.html( '你未选择文件，请重新选择' ).show();
                item.addClass( 'item-err' );
                $( '#configuploadFormBtn' ).trigger( 'enable', {disabled: true} );
                return false;
            }
            var val = image.val();
            var ext = val.substring( val.lastIndexOf( '.' ) + 1 );
            ext = $.trim( ext );
            var validExt = ext == 'gz' || ext == 'GZ';
            if ( !validExt ) {
                err.html( '文件格式错误，请重新选择' ).show();
                item.addClass( 'item-err' );
                $( '#configuploadFormBtn' ).trigger( 'enable', {disabled: true} );
                return false;
            }
            err.html('');
            item.removeClass( 'item-err' );
            $( '#configuploadFormBtn' ).trigger( 'enable', {disabled: false} );
        } );
        $( 'body' ).undelegate( '#configuploadFormBtn', 'click' );
        $( 'body' ).delegate( '#configuploadFormBtn', 'click', function( e ){
            e.preventDefault();
            uploadfile();
            return false;
        });
    });

    $.sub( 'config:init', function(){
        $('#btnBackupconfig').on('click', function(e){
            e.preventDefault();
            $.pub( 'config:backup' );
        });
        $('#btnUploadconfig').on('click', function(e){
            e.preventDefault();
            $.pub( 'config:upload' );
        });
    });

    $.sub('datetime', function(){
        var TIMEZONES =  [
                ['CST+12', '(UTC-12)国际日期变更线西'],
                ['CST+11', '(UTC-11)萨摩亚群岛'],
                ['CST+11', '(UTC-11)协调世界时'],
                ['CST+10', '(UTC-10)夏威夷'],
                ['CST+9:30', '(UTC-9:30)马克萨斯群岛标准时间'],
                ['CST+9', '(UTC-9)阿拉斯加'],
                ['CST+8', '(UTC-8)太平洋时间(美国和加拿大)'],
                ['CST+8', '(UTC-8)下加利福尼亚州'],
                ['CST+7', '(UTC-7)奇瓦瓦,拉巴斯,马萨特兰'],
                ['CST+7', '(UTC-7)山地时间(美国和加拿大)'],
                ['CST+7', '(UTC-7)亚利桑那'],
                ['CST+6', '(UTC-6)瓜达拉哈拉,墨西哥城,蒙特雷'],
                ['CST+6', '(UTC-6)萨斯克彻温'],
                ['CST+6', '(UTC-6)中部时间(美国和加拿大)'],
                ['CST+6', '(UTC-6)中美洲'],
                ['CST+5', '(UTC-5)波哥大,利马,基多'],
                ['CST+5', '(UTC-5)东部时间(美国和加拿大)'],
                ['CST+5', '(UTC-5)印第安纳州(东部)'],
                ['CST+4:30', '(UTC-4:30)加拉加斯'],
                ['CST+4', '(UTC-4)大西洋时间(加拿大)'],
                ['CST+4', '(UTC-4)库亚巴'],
                ['CST+4', '(UTC-4)乔治敦,拉巴斯,马瑙斯,圣湖安'],
                ['CST+4', '(UTC-4)圣地亚哥'],
                ['CST+4', '(UTC-4)亚松森'],
                ['CST+3:30', '(UTC-3:30)纽芬兰'],
                ['CST+3', '(UTC-3)巴西利亚'],
                ['CST+3', '(UTC-3)布宜诺斯艾利斯'],
                ['CST+3', '(UTC-3)格陵兰'],
                ['CST+3', '(UTC-3)卡宴,福塔雷萨'],
                ['CST+3', '(UTC-3)蒙得维的亚'],
                ['CST+2', '(UTC-2)协调世界时-02'],
                ['CST+2', '(UTC-2)中大西洋'],
                ['CST+1', '(UTC-1)佛得角群岛'],
                ['CST+1', '(UTC-1)亚速尔群岛'],
                ['CST', '(UTC)都柏林,爱丁堡,里斯本,伦敦'],
                ['CST', '(UTC)卡萨布兰卡'],
                ['CST', '(UTC)蒙罗维亚,雷克雅未克'],
                ['CST', '(UTC)协调世界时'],
                ['CST-1', '(UTC+1)阿姆斯特丹,柏林,伯尔尼,罗马,斯德歌尔摩,维也纳'],
                ['CST-1', '(UTC+1)贝尔格莱德,布拉迪斯拉发,布达佩斯,卢布尔雅那'],
                ['CST-1', '(UTC+1)布鲁塞尔,哥本哈根,马德里,巴黎'],
                ['CST-1', '(UTC+1)萨拉热窝,斯科普里,华沙,萨格勒布'],
                ['CST-1', '(UTC+1)温得和克'],
                ['CST-1', '(UTC+1)中非西部'],
                ['CST-2', '(UTC+2)安曼'],
                ['CST-2', '(UTC+2)贝鲁特'],
                ['CST-2', '(UTC+2)大马士革'],
                ['CST-2', '(UTC+2)哈拉雷,比勒陀利亚'],
                ['CST-2', '(UTC+2)赫尔辛基,基辅,里加,索非亚,塔林,维尔纽斯'],
                ['CST-2', '(UTC+2)开罗'],
                ['CST-2', '(UTC+2)明斯克'],
                ['CST-2', '(UTC+2)雅典,布加勒斯特'],
                ['CST-2', '(UTC+2)耶路撒冷'],
                ['CST-2', '(UTC+2)伊斯坦布尔'],
                ['CST-3', '(UTC+3)巴格达'],
                ['CST-3', '(UTC+3)加里宁格勒'],
                ['CST-3', '(UTC+3)科威特,利雅得'],
                ['CST-3', '(UTC+3)内罗毕'],
                ['CST-3:30', '(UTC+3:30)德黑兰'],
                ['CST-4', '(UTC+4)阿布扎比,马斯喀特'],
                ['CST-4', '(UTC+4)埃里温'],
                ['CST-4', '(UTC+4)巴库'],
                ['CST-4', '(UTC+4)第比利斯'],
                ['CST-4', '(UTC+4)路易港'],
                ['CST-4', '(UTC+4)莫斯科,圣彼得堡,伏尔加格勒'],
                ['CST-4:30', '(UTC+4:30)喀布尔'],
                ['CST-5', '(UTC+5)塔什干'],
                ['CST-5', '(UTC+5)伊斯兰堡,卡拉奇'],
                ['CST-5:30', '(UTC+5:30)钦奈,加尔各答,孟买,新德里'],
                ['CST-5:30', '(UTC+5:30)斯里加亚渥登普拉'],
                ['CST-5:45', '(UTC+5:45)加德满都'],
                ['CST-6', '(UTC+6)阿斯塔纳'],
                ['CST-6', '(UTC+6)达卡'],
                ['CST-6', '(UTC+6)叶卡捷琳堡'],
                ['CST-6:30', '(UTC+6:30)仰光'],
                ['CST-7', '(UTC+7)曼谷,河内,雅加达'],
                ['CST-7', '(UTC+7)新西伯利亚'],
                ['CST-8', '(UTC+8)北京,重庆,香港特别行政区,乌鲁木齐'],
                ['CST-8', '(UTC+8)吉隆坡,新加坡'],
                ['CST-8', '(UTC+8)克拉斯诺亚尔斯克'],
                ['CST-8', '(UTC+8)珀斯'],
                ['CST-8', '(UTC+8)台北'],
                ['CST-8', '(UTC+8)乌兰巴托'],
                ['CST-8:30', '(UTC+8:30)朝鲜标准时间'],
                ['CST-9', '(UTC+9)大阪,札幌,东京'],
                ['CST-9', '(UTC+9)首尔'],
                ['CST-9', '(UTC+9)伊尔库茨克'],
                ['CST-9:30', '(UTC+9:30)阿德莱德'],
                ['CST-9:30', '(UTC+9:30)达尔文'],
                ['CST-10', '(UTC+10)布里斯班'],
                ['CST-10', '(UTC+10)关岛,莫尔兹比港'],
                ['CST-10', '(UTC+10)霍巴特'],
                ['CST-10', '(UTC+10)堪培拉,墨尔本,悉尼'],
                ['CST-10', '(UTC+10)雅库茨克'],
                ['CST-10:30', '(UTC+10:30)澳大利亚远东标准时间'],
                ['CST-11', '(UTC+11)符拉迪沃斯托克'],
                ['CST-11', '(UTC+11)所罗门群岛,新喀里多尼亚'],
                ['CST-11:30', '(UTC+11:30)诺福克岛标准时间'],
                ['CST-12', '(UTC+12)奥克兰,惠灵顿'],
                ['CST-12', '(UTC+12)斐济'],
                ['CST-12', '(UTC+12)马加丹'],
                ['CST-12', '(UTC+12)协调世界时+12'],
                ['CST-12:45', '(UTC+12:45)查塔姆群岛标准时间'],
                ['CST-13', '(UTC+13)努库阿洛法'],
                ['CST-14', '(UTC+14)基里巴斯']
            ],indexDict = {
                "CST+3:30": [
                    24
                ],
                "CST-6": [
                    71,
                    72,
                    73
                ],
                "CST-12:45": [
                    102
                ],
                "CST+6": [
                    11,
                    12,
                    13,
                    14
                ],
                "CST+11": [
                    1,
                    2
                ],
                "CST": [
                    34,
                    35,
                    36,
                    37
                ],
                "CST-8": [
                    77,
                    78,
                    79,
                    80,
                    81,
                    82
                ],
                "CST-9": [
                    84,
                    85,
                    86
                ],
                "CST-5:30": [
                    68,
                    69
                ],
                "CST-9:30": [
                    87,
                    88
                ],
                "CST-4:30": [
                    65
                ],
                "CST+10": [
                    3
                ],
                "CST+3": [
                    25,
                    26,
                    27,
                    28,
                    29
                ],
                "CST-8:30": [
                    83
                ],
                "CST-10": [
                    89,
                    90,
                    91,
                    92,
                    93
                ],
                "CST-10:30": [
                    94
                ],
                "CST-2": [
                    44,
                    45,
                    46,
                    47,
                    48,
                    49,
                    50,
                    51,
                    52,
                    53
                ],
                "CST+12": [
                    0
                ],
                "CST-14": [
                    104
                ],
                "CST-12": [
                    98,
                    99,
                    100,
                    101
                ],
                "CST-5": [
                    66,
                    67
                ],
                "CST+4:30": [
                    18
                ],
                "CST-1": [
                    38,
                    39,
                    40,
                    41,
                    42,
                    43
                ],
                "CST-3": [
                    54,
                    55,
                    56,
                    57
                ],
                "CST+9": [
                    5
                ],
                "CST-7": [
                    75,
                    76
                ],
                "CST-4": [
                    59,
                    60,
                    61,
                    62,
                    63,
                    64
                ],
                "CST-13": [
                    103
                ],
                "CST-11:30": [
                    97
                ],
                "CST-11": [
                    95,
                    96
                ],
                "CST-3:30": [
                    58
                ],
                "CST-5:45": [
                    70
                ],
                "CST+8": [
                    6,
                    7
                ],
                "CST+1": [
                    32,
                    33
                ],
                "CST+9:30": [
                    4
                ],
                "CST+2": [
                    30,
                    31
                ],
                "CST+7": [
                    8,
                    9,
                    10
                ],
                "CST-6:30": [
                    74
                ],
                "CST+4": [
                    19,
                    20,
                    21,
                    22,
                    23
                ],
                "CST+5": [
                    15,
                    16,
                    17
                ]
            },
            getMaxDays = function(year, month) {
                var tmpDate = new Date(year, month-1, 1),
                    d = 28, m;
                m = tmpDate.getMonth();
                d = 28;
                while (tmpDate.getMonth() == m) {
                    d ++;
                    tmpDate.setDate(d);
                }
                return d - 1;
            },
            randerYear = function(y){
                var min = y - 10,
                    max = y + 10;
                var options = [];
                for (var i = min; i <= max; i++) {
                    if (y === i) {
                        options.push('<option value="'+ i +'" selected="selected">'+ i +'</option>');
                    } else {
                        options.push('<option value="'+ i +'">'+ i +'</option>');
                    }
                }
                return options.join('');
            },
            randerMonth = function(m){
                var options = [];
                for (var i = 1; i <= 12; i++) {
                    if (m === i) {
                        options.push('<option value="'+ i +'" selected="selected">'+ i +'</option>');
                    } else {
                        options.push('<option value="'+ i +'">'+ i +'</option>');
                    }
                }
                return options.join('');
            },
            randerDay = function(year, month, day){
                var days = getMaxDays(year, month);
                var options = [];
                for (var i = 1; i <= days; i++) {
                    if (day === i) {
                        options.push('<option value="'+ i +'" selected="selected">'+ i +'</option>');
                    } else {
                        options.push('<option value="'+ i +'">'+ i +'</option>');
                    }
                }
                return options.join('');
            },
            randerHour = function(h){
                var options = [];
                for (var i = 0; i <= 23; i++) {
                    if (h === i) {
                        options.push('<option value="'+ i +'" selected="selected">'+ i +'</option>');
                    } else {
                        options.push('<option value="'+ i +'">'+ i +'</option>');
                    }
                }
                return options.join('');
            },
            randerMin = function(m){
                var options = [];
                for (var i = 0; i <= 59; i++) {
                    if (m === i) {
                        options.push('<option value="'+ i +'" selected="selected">'+ i +'</option>');
                    } else {
                        options.push('<option value="'+ i +'">'+ i +'</option>');
                    }
                }
                return options.join('');
            },
            randerSec = function(s){
                var options = [];
                for (var i = 0; i <= 59; i++) {
                    if (s === i) {
                        options.push('<option value="'+ i +'" selected="selected">'+ i +'</option>');
                    } else {
                        options.push('<option value="'+ i +'">'+ i +'</option>');
                    }
                }
                return options.join('');
            },
            randerTimezone = function(now,index){
                var options = [],val;
                for(var attr in indexDict){
                    if(attr === now ) {
                        val = indexDict[attr][index];

                    }
                }
                for (var i = 0; i < TIMEZONES.length; i++) {
                    if ( i === val) {
                        options.push('<option value="'+ TIMEZONES[i][0] +'" selected="selected">'+ TIMEZONES[i][1] +'</option>');
                    } else {
                        options.push('<option value="'+ TIMEZONES[i][0] +'">'+ TIMEZONES[i][1] +'</option>');
                    }
                }
                return options.join('');
            },
            getTimezone = function(now,index){
                var val;
                for(var attr in indexDict){
                    if(attr === now ) {
                        val = TIMEZONES[indexDict[attr][index]][1];

                    }
                }
                return val;
            };

        var routerDatetime;

        var dlgTimezone, dlgDatetime, updateDatetime;
        updateDatetime = function(d){
            var optionsYear = randerYear(d.year);
            $('#year').html(optionsYear);
            var optionsMonth = randerMonth(d.month);
            $('#month').html(optionsMonth);
            var optionsDay = randerDay(d.year, d.month, d.day);
            $('#day').html(optionsDay);

            var optionsHour = randerHour(d.hour);
            $('#hour').html(optionsHour);
            var optionsMin = randerMin(d.min);
            $('#minute').html(optionsMin);
            var optionsSec = randerSec(d.sec);
            $('#second').html(optionsSec);
        };

        $('#btnTimezone').click(function(e){
            e.preventDefault();
            dlgTimezone = $.dialog({
                width: 390,
                title: '更改时区',
                content: $('#tpltimezone').html(),
                lock: true
            });

            setTimeout(function(){
                var options = randerTimezone(routerDatetime.timezone,routerDatetime.index);
                console.log(options);
                $('#timezone').html(options);
                $.selectBeautify({container: '.dialog-timezone'});
            }, 200);
        });

        $('#btnDatetime').click(function(e){
            e.preventDefault();
            dlgDatetime = $.dialog({
                width: 430,
                title: '更改时间',
                content: $('#tpldatetime').html(),
                lock: true
            });
            setTimeout(function(){

                updateDatetime(routerDatetime);

                var updateDays = function(){
                    var y = $('#year').val(),
                        m = $('#month').val(),
                        d = new Date().getDate();
                    var optionsDay = randerDay(y, m, d);
                    $('#day').html(optionsDay);
                }
                $('#year').on('change', updateDays);
                $('#month').on('change', updateDays);
            }, 200);
        });

        $('body').delegate('#btnGetNowDate', 'click', function(e){
            e.preventDefault();
            var dObj = {},
                d = new Date();
            dObj.year = d.getFullYear();
            dObj.month = d.getMonth() + 1;
            dObj.day = d.getDate();
            dObj.hour = d.getHours();
            dObj.min = d.getMinutes();
            dObj.sec = d.getSeconds();
            updateDatetime(dObj);
        });

        $('body').delegate('#btnTimezoneSubmit', 'click', function(e){
            e.preventDefault();
            var timezone = $('#timezone').val();
            var index;
            $('#timezone option').each(function(i){
                if (this.selected == true) {
                    for(var j = 0; j < indexDict[timezone].length; j++){
                        if (indexDict[timezone][j] == i) {
                            index = j;
                        }
                    }

                }
            })
            $.post('/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/set_sys_time', {timezone: timezone,index: index}, function(rsp){
                rsp = $.parseJSON(rsp);
                if (rsp.code === 0) {
                    dlgTimezone.close();
                    location.reload();
                } else {
                    $.alert(rsp.msg);
                }
            });
        });

        $('body').delegate('#btnDatetimeSubmit', 'click', function(e){
            e.preventDefault();
            var time = $('#year').val() + '-' + $('#month').val() + '-' + $('#day').val() + ' ' + $('#hour').val() + ':' + $('#minute').val() + ':' + $('#second').val();
            $.post('/cgi-bin/luci/;stok=9d20ad8ac8b9577cbc6c3948ac3efb94/api/misystem/set_sys_time', {time: time}, function(rsp){
                rsp = $.parseJSON(rsp);
                if (rsp.code === 0) {
                    dlgDatetime.close();
                    $.alert('设置成功，稍后生效，请等待一会刷新。');
                } else {
                    $.alert(rsp.msg);
                }
            });
        });

    });

    $(function(){
//        $.pub( 'upgrade:check' );
        $.pub( 'upgrade:download' );
        $.pub( 'upgrade:upload' );
        $.pub( 'uploadlog' );
        $.pub( 'reset' );
        if (document.getElementById('lang')) {
            $.pub( 'langset' );
        }
        $.pub( 'config:init' );
        $.pub('datetime');
        getfoot()
    });


    function getfoot() {
        $.post("/cgi-bin/status.lua", {getcfg: 1}, function (response, status, xhr) {
            if (response.code === 0) {
                document.getElementById('ft').innerHTML = template('ft_template', {
                    data: response
                });
                $("#upgradeinfoNumber").text(response.fv)
            }
        }, "json");
    }
</script>

</body>
</html>