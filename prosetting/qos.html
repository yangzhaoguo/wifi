<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="ie6 oldie" lang="zh"><![endif]-->
<!--[if IE 7]>
<html class="ie7 oldie" lang="zh"><![endif]-->
<!--[if IE 8]>
<html class="ie8 oldie" lang="zh"><![endif]-->
<!--[if gt IE 8]><!-->
<html lang="zh"> <!--<![endif]-->
<head>
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <link rel="icon" href="../logo_ico.ico" type="img/x-ico"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="renderer" content="webkit">
    <!--[if lt IE 7]>
    <![endif]-->
    <!--[if gte IE 9]>
    <style>
        body {
            filter: none;
        }
    </style>
    <link rel="icon" href="../logo_ico.ico" type="img/x-ico"/>
    <![endif]-->
    <title>灵铱科技有限公司</title>
    <meta name="viewport" content="width=1200">
    <link href="/xuci/assets/css/bc.css-v=0.0.3.css" rel="stylesheet">
    <link href="/xuci/assets/css/qos.css-v=0.0.3.css" rel="stylesheet">
    <link href="/xuci/assets/css/index.css-v=0.0.3.css" rel="stylesheet">
    <link href="/xuci/assets/css/qos.css-v=0.0.3.css" rel="stylesheet">
</head>
<body>
<div id="doc">
    <noscript>
        <div class="noscript">你的浏览器禁止了Javascript功能，会造成无法使用系统进行路由器管理，请开启。</div>
    </noscript>
    <script>
        var GLOBALHEADER = true;
    </script>
    <div id="hd">
        <div class="inner">
            <div class="mod-head clearfix">
                <h1 id="logo">
                    <a href="/home.html">
                        <img src="/xuci/assets/img/logo.png" alt="灵铱路由器">
                    </a>
                </h1>
                <div id="nav">
                    <ul>
                        <li>
                            <a href="/home.html">路由状态</a>
                        </li>
                        <li>
                            <a href="/setting/wifi.html">常用设置</a>
                        </li>
                        <li class="active">
                            <a href="/prosetting/qos.html">高级设置</a>
                        </li>
                    </ul>
                </div>
                <div id="userbar" style="display: none">
                    <span id="sysmenu" class="name s-dropdown">LingYi-WiFi</span>
                </div>
            </div>

        </div>
    </div>


    <div class="mod-netmap">
        <div class="mod-set-nav mod-set-nav-pro">
            <ul class="clearfix li-6">
                <li class="active"><a href="qos.html">
                    <i class="ico ico-6"></i>
                    <span>QoS智能限速</span>
                </a>
                </li>
                <li>
                    <a href="dhcpipmacband.html">
                        <i class="ico ico-8"></i>
                        <span>DHCP静态IP分配</span>
                    </a>
                </li>
                <li>
                    <a href="ddns.html">
                        <i class="ico ico-9"></i>
                        <span>DDNS</span>
                    </a>
                </li>
                <li>
                    <a href="nat.html">
                        <i class="ico ico-10"></i>
                        <span>端口转发</span>
                    </a>
                </li>
                <li>
                    <a href="vpn.html">
                        <i class="ico ico-11"></i>
                        <span>VPN</span>
                    </a>
                </li>
                <li><a href="upnp.html">
                    <i class="ico ico-7"></i>
                    <span>其他</span>
                </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="bd">
    <div class="mod-set mod-bandwidth">
        <div class="hd">
            <h3>最高速度设置</h3>
        </div>
        <div class="bd">
            <div class="speed-needtest nospeed" style="display:none;">
                <div class="speed-result">
                    <div id="">
                        <div class="mod-speed-result" style="text-align:left;">
                            <ul class="clearfix">
                                <li class="first">
                                    <span class="num" id="outband-up">--</span>
                                    <span class="con">
                                            MB/s<br>
                                            最高上传速度
                                        </span>
                                </li>
                                <li>
                                    <span class="num" id="outband-down">--</span>
                                    <span class="con">
                                            MB/s<br>
                                            最高下载速度
                                        </span>
                                </li>
                            </ul>
                            <div class="btns">
                                <a href="#" id="btnBandset" class="btn btn-dft btn-m" data-upband=""
                                   data-downband=""><span>限速设置</span></a>
                                <div class="result-tip" style="display:none">无限速阈值，请先进行限速设置</div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div class="mod-qos-speedtest hasspeed" style="display:none;">
                <div class="speed-result">
                    <div id="speedresult"></div>
                </div>
            </div>
            <div class="mod-qos-alert" style="display:none">
                <p>当外网下载带宽超过50Mbps时，建议无需开启QoS功能</p>
            </div>
        </div>
    </div>
    <!--  -->
    <div class="mod-set mod-qos">
        <div class="hd" style="margin-bottom:0px;">
            <h3>QoS智能分配</h3>
            <div class="switch">
                <a data-enable="1" class="btn-switch btn-switch-on" id="btnqos" href="#"></a>
            </div>
        </div>
        <div class="bd">
            <div class="mod-qos-set hasspeed">
                <div class="isoff" id="qosoff" style="display:none;">当前QoS服务暂未开启</div>
                <div class="ison" id="qosset" style="display:none;">
                    <div class="models settings" style="padding-top:40px;">
                        <h4 class="tit">根据应用优先级分配网速</h4>
                        <div id="qosmode" class="tab clearfix">
                            <ul>
                                <li data-value="0" style="display:none;">自动模式</li>
                                <li data-value="1" style="display:none;">优先级模式</li>
                                <li data-value="2" style="display:none;">手工限速模式</li>
                                <li data-value="3" class="first active">自动模式</li>
                                <li data-value="4">游戏优先</li>
                                <li data-value="5">网页优先</li>
                                <li data-value="6">视频优先</li>
                            </ul>
                        </div>
                        <div id="qosmodedesc" class="tab-content" style="margin-bottom:25px;">
                            <p>自动模式下路由器会根据当前网络使用情况动态调整带宽分配，保证网络体验流畅</p>
                            <p>优先级模式下路由器会动态调整带宽分配，保证优先级较高的设备网络体验流畅</p>
                            <p>手工模式下路由器会根据您设置的速度调整带宽分配</p>
                            <p>系统根据设备需要自动调配网速</p>
                            <p>优先保证打游戏的网速，不卡顿不掉线</p>
                            <p>优先保证浏览网页的网速，大图秒打开</p>
                            <p>优先保证看视频的网速，高清也流畅</p>
                        </div>
                        <hr></hr>
                    </div>
                    <div class="settings">
                        <h4>家庭WiFi限速 <i class="ico ico-refresh" id="refresh"></i></h4>
                        <div class="table-devices" id="tableauto" style="display:none">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th width="270">设备名称</th>
                                    <th width="270">设备信息</th>
                                    <th>当前网速</th>
                                    <!--<th width="180" class="center">限速模式</th>-->
                                    <th width="180">最大速度</th>
                                </tr>
                                </thead>
                                <tbody id="devlistauto"></tbody>
                            </table>
                            <div class="btns-edit">
                                <a href="#" class="btn btn-dft btn-l btnEditQos" data-mode="0"><span>编辑</span></a>
                            </div>
                        </div>
                        <div id="tablepriority" class="table-devices" style="display:none">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th width="270">设备名称</th>
                                    <th width="270">设备信息</th>
                                    <th>当前网速</th>
                                    <th width="180" class="center">优先级</th>
                                </tr>
                                </thead>
                                <tbody id="devlistpriority"></tbody>
                            </table>
                            <div class="btns-edit">
                                <a href="#" class="btn btn-dft btn-l btnEditQos" data-mode="1"><span>编辑</span></a>
                            </div>
                        </div>
                        <div class="table-devices" id="tablecustom" style="display:none">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th width="270">设备名称</th>
                                    <th width="270">设备信息</th>
                                    <th>当前网速</th>
                                    <th width="180">最大速度</th>
                                </tr>
                                </thead>
                                <tbody id="devlistcustom"></tbody>
                            </table>
                            <div class="btns-edit">
                                <a href="#" class="btn btn-dft btn-l btnEditQos" data-mode="2"><span>编辑</span></a>
                            </div>
                        </div>
                        <hr></hr>
                    </div>
                    <div id="guest-limit">
                        <script type="tmpl/html" id="guest-limit-script">
                            <div class="mod-qos-speedtest settings">
                                <h4 class="tit">访客WiFi限速:</h4>
                                <div class="mod-speed-result" style="padding-top:0px;">
                                    <ul class="clearfix">
                                        <li class="first">
                                            <span class="num">{$up}</span>
                                            <span class="con">
                                                KB/S<br>
                                                上传限速
                                            </span>
                                        </li>
                                        <li>
                                            <span class="num">{$down}</span>
                                            <span class="con">
                                                KB/S<br>
                                                下载限速
                                            </span>
                                        </li>
                                    </ul>
                                    <div class="btns-edit">
                                        <a href="#" class="btn-limit btn btn-dft" data-mode="guest" data-up="{$up}" data-down="{$down}">
                                            <span>编辑</span>
                                        </a>
                                    </div>
                                </div>
                                <hr></hr>
                            </div>
                        </script>
                    </div>
                    <div id="local-limit">
                        <script type="tmpl/html" id="local-limit-script">
                            <div class="mod-qos-speedtest settings">
                                <h4 class="tit">路由器自身上传下载限速:</h4>
                                <div class="mod-speed-result" style="padding-top:0px;">
                                    <ul class="clearfix">
                                        <li class="first">
                                            <span class="num">{$up}</span>
                                            <span class="con">
                                                KB/S<br>
                                                上传限速
                                            </span>
                                        </li>
                                        <li>
                                            <span class="num">{$down}</span>
                                            <span class="con">
                                                KB/S<br>
                                                下载限速
                                            </span>
                                        </li>
                                    </ul>
                                    <div class="btns-edit">
                                        <a href="#" class="btn-limit btn btn-dft" data-mode="local" data-up="{$up}" data-down="{$down}">
                                            <span>编辑</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="ft">
    <p class="rom-ver">系统版本: 2.25.122 开发版  MAC地址: 78:11:DC:4C:B5:04</p>
    <p>&copy; 2018 灵铱路由器</p>
</div>
<script type="text/template" id="ft_template">
    <p class="rom-ver">系统版本: <%=(data.fv)%> 开发版  MAC地址: <%=(data.mac)%></p>
    <p>&copy; 2018 灵铱路由器</p>
</script>

</div>

<!--[if lt IE 7]>
<script>
    try {
        document.execCommand("BackgroundImageCache", false, true);
    } catch (e) {
    }
</script>
<![endif]-->
<div class="mask-menu" id="maskMenu"
     style="position:fixed;left:0;top:0; width:100%; height:100%; z-index:2; display:none;"></div>
<div id="dropmenu" class="dropmenu" style="z-index:3; display:none;">
    <ul>
        <li><a href="#" id="toRename">修改路由器名称</a></li>

        <li><a href="setting/upgrade">系统升级</a></li>

        <li><a href="#" id="toDownloadClient">下载客户端</a></li>
        <li><a href="#" id="toReboot">重启</a></li>

        <li class="last"><a href="/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/web/logout">注销</a></li>
    </ul>
</div>
<div id="noticebar" class="noticebar" style="z-index:3; display:none;">
    <i class="ico-arrow"></i>
    <div class="content"></div>
</div>
<script>
    var i18n = {};
    i18n.dialog = {
        ok: '确认',
        cancel: '取消',
        loading: '加载中...',
        dlgtitle: '消息框'
    };
    i18n.valid = {
        n_integer: '请输入一个{$0}位正整数。',
        n_format: '数字输入格式为&#34;{$0}&#34;。',
        n_upper: '输入值太大，最大允许{$0}。', //注意：{$0}表示允许值，{$1}表示实际值
        n_lower: '输入值太小，最小允许{$0}。',
        nrange_from: '您输入的范围不合理。',
        nrange_to: '您输入的范围不合理。',
        n_useless_zero: '数字前面好像有多余的&#34;0&#34;。',
        d_format: '日期输入格式为&#34;YYYY-MM-DD&#34;。',
        d_upper: '日期太晚，最晚允许{$0}。',
        d_lower: '日期太早，最早允许{$0}。',
        daterange_from: '起始日期不能大于截止日期。',
        daterange_to: '截止日期不能小于起始日期。',
        daterange_larger_span: "时间跨度不得超过{$0}天。",
        text_longer: '最多允许{$0}个字。', //'{$1}字太多，最多允许{$0}字'
        text_shorter: '请至少输入{$0}个字。', //'{$1}字太少，最少允许{$0}字'
        bytetext_longer: '最多允许{$0}个字节。', //'{$1}字节太多，最多允许{$0}字节'
        bytetext_shorter: '请至少输入{$0}个字节。', //'{$1}字节太少，最少允许{$0}字节'
        richtext_longer: '最多允许{$0}个字。',
        richtext_shorter: '请至少输入{$0}个字。',
        _reconfirm: '两次输入不一致。',
        _time: '请检查您输入的时间格式。',
        _minute: '请检查您输入的时间格式。',
        _email: '请检查您输入的Email格式。',
        _mobilecode: '请检查您输入的手机号码。',
        _phone: '请检查您输入的电话号码。',
        _phonewithext: '请检查您输入的电话号码。',
        _phonezone: '请检查您输入的电话区号。',
        _phonecode: '请检查您输入的电话号码。',
        _phoneext: '请检查您输入的电话分机号码。',
        _zipcode: '请检查您输入的邮政编码。',
        _idnumber: '请检查您输入的身份证号码，目前只支持15位或者18位。',
        _bankcard: '请检查您输入的银行账号。',
        _cnname: '请检查您输入的姓名。',
        _vcode: '请检查您输入的验证码。',
        _imgfile: '请检查您选择的图片文件路径，只支持jpg、jpeg、png、gif、tif、bmp格式。',
        _regexp: '请检查您的输入。',
        _magic: '请检查您的输入。',
        _req_text: '请填写{$0}。',
        _req_select: '请选择{$0}。',
        _req_file: '请上传{$0}。',
        _logicrequired: '{$0}输入不完整.',
        _ssid: '请输入标准字符，如 Xiaomi.Luyouqi',
        _macaddr: 'MAC地址格式有误，如ab:cd:ef:11:22:33',
        _weppassword: '密码输入有误',
        _wifipassword: '不能包含中文',
        _ipaddr: 'IP地址由4个 0~255 之间的数字组成，数字之间用点区隔',
        _url: '必须是完整的URL,如 http://miwifi.com'
    };
</script>
<script src="/xuci/assets/js/jquery-1.8.3.js"></script>
<script src="/xuci/assets/js/qwrap.js"></script>
<script src="/xuci/assets/js/common.js"></script>
<script src="/xuci/assets/js/raphael.js"></script>
<script src="/xuci/assets/js/crypto-js/rollups/sha1.js"></script>
<script src="/xuci/assets/js/crypto-js/rollups/aes.js"></script>
<script src="/xuci/assets/js/valid.js"></script>
<script src="/xuci/assets/js/selectbeautify.js"></script>
<script src="/xuci/assets/js/jquery.dialog.js"></script>
<script src="/xuci/assets/js/jquery.cookie.js"></script>
<script src="/xuci/assets/js/template-web.js"></script>
<script>
    (function () {
        var G_FEATURES = $.parseJSON('{"netmode":{"elink":"1"},"hardware":{"disk":"0","usb":"1"},"wifi":{"wifimerge":"1","wifiguest":"1","wifi24":"1","wifi50":"1"},"apps":{"apptc":"0","qos":"1"},"apmode":{"lanapmode":"1","wifiapmode":"1"},"system":{"infileupload":"1","downloadlogs":"0","shutdown":"0","i18n":"0","task":"0"}}');
        window['G_FEATURES'] = G_FEATURES;
    }())
</script>

<script>
    // reboot
    var global_api_reboot = {
        url: '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/xqsystem/reboot',
        param: {"client": "web"}
    };

    function reboot_window(needconfirm) {
        console.log(needconfirm);
        var reboot = function () {
            $.getJSON(global_api_reboot.url, global_api_reboot.param, function (rsp) {
                if (rsp.code !== 0) {
                    $.alert(rsp.msg).time(1.5 * 1000);
                } else {
                    var ip = rsp.lanIp[0].ip;
                    rebootWait({
                        lanIp: ip,
                        action: '重启路由器',
                        refresh: true
                    });
                }
            });
        };
        if (typeof( needconfirm ) !== "undefined" && needconfirm === false) {
            reboot();
            return;
        }
        $.confirm('确定重启路由器，重启将断开和灵铱路由器的连接。', function () {
            var dlg = this;
            reboot();
            dlg.close();
            return false;
        });
    }

    // shutdown
    function shutdown_window() {
        $.confirm('是否确定关闭路由器，操作将断开和灵铱路由器的连接。', function () {
            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/xqsystem/shutdown', {}, function (rsp) {
                if (rsp.code !== 0) {
                    $.alert(rsp.msg).time(1.5 * 1000);
                } else {
                    $.loadingDialog({
                        title: '关闭路由器',
                        content: '关机中，请等待路由器指示灯熄灭后再断开电源'
                    });
                }
            });
        });
    }

    //reset
    function reset_window(format) {

        var reset = (function (format) {
            var requestURL = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/xqsystem/reset',
                requestData = {
                    format: format ? 1 : 0
                },
                wait = function () {
                    rebootWait({
                        action: '恢复出厂设置',
                        refresh: true,
                        lanIp: '192.168.31.1'
                    });
                },
                clearCookies = function () {
                    var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
                    if (keys) {
                        for (var i = keys.length; i--;) {
                            document.cookie = keys[i] + '=0;path=/;expires=' + new Date(0).toUTCString();
                        }
                    }
                };

            return function () {
                $.getJSON(requestURL, requestData, function (rsp) {
                    if (rsp.code !== 0) {
                        $.alert(rsp.msg).time(3 * 1000);
                    } else {
                        // clear cookies
                        clearCookies();
                        //block wait
                        wait();
                    }
                });
            }
        })(format);

        $.confirm('确定要恢复出厂设置让灵铱路由器回到初始状态？', function () {
            reset();
        });
    }
</script>
<script type="text/tmpl" id="tplrename">
<div class="mod-rename-dlg">
    <p class="img"><img src="/xiaoqiang/web/img/topograph/router_r3g_101.png"></p>
    <div class="form-rename">
        <form action="#" class="form" id="routerNameEdit">
            <div class="form-item">
                <label class="k">路由器名称</label>
                <span class="v">
                    <input type="text" name="routername" id="routername" class="ipt-text" autocomplete="off" datatype="bytetext" maxlength="24" reqMsg="路由器名称" value="{$name}">
                </span>
                <em class="t"></em>
            </div>
            <div class="form-item">
                <label class="k">位置</label>
                <span class="v">
                    <input type="text" name="locale" id="locale" class="ipt-text" autocomplete="off" datatype="bytetext" maxlength="24" reqMsg="路由器位置" value="{$locale}">
                </span>
                <em class="t"></em>
            </div>
            <div class="form-contral">
                <button type="submit" class="btn btn-primary btn-l"><span>保存</span></button>
            </div>
        </form>
    </div>
</div>


</script>
<script type="text/tmpl" id="tplshutdown">
<div class="mod-reboot-dlg">
    <p class="img"><img src="/xiaoqiang/web/img/ico_shutdown.png"></p>
    <p class="text">关闭路由器将断开其他设备的数据访问和网络连接，之后便可以安全的断开电源。（再次启动需要手工连接电源）</p>
    <button id="shutdownAction" type="button" class="btn btn-primary btn-l"><span>关闭路由器</span></button>
</div>


</script>
<script type="text/tmpl" id="tplreboot">
<div class="mod-shutdown-dlg">
    <p class="img"><img src="/xiaoqiang/web/img/ico_reboot.png"></p>
    <p class="text">路由器重启需要等待十几秒或更多时间，重启过程中将会断开网络连接，稍后将自动重新连接网络。</p>
    <button type="button" id="rebootAction" class="btn btn-primary btn-l"><span>重启路由器</span></button>
</div>


</script>
<script type="text/tmpl" id="tpldownloadclient">
<div class="mod-downloadclient-dlg">
    <table>
        <tr>
            <td>
                <i class="ico-down-client ico-down-pc"></i>
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqpc_client.exe">PC客户端</a>
            </td>
            <td class="c1"></td>
            <td class="c2"></td>
            <td>
                <i class="ico-down-client ico-down-mac"></i>
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqmac_client.dmg">MAC客户端</a>
            </td>
        </tr>
        <tr class="last">
            <td>
                <i class="ico-down-client ico-down-andriod"></i>
            
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqapp_dev.apk">Android客户端</a>
                <img class="onlineimg" src-local="/xiaoqiang/web/img/2dcode.png" src="http://www1.miwifi.com/statics/img/wf_2dcode_an_dl_dev.png">
            
            </td>
            <td class="c1"></td>
            <td class="c2"></td>
            <td>
                <i class="ico-down-client ico-down-iphone"></i>
                <a href="https://itunes.apple.com/cn/app/id859962702?mt=8&ls=1">iPhone客户端</a>
                <img class="onlineimg" src-local="/xiaoqiang/web/img/2dcode.png" src="http://www1.miwifi.com/statics/img/wf_2dcode_ios_dl.png">
            </td>
        </tr>
    </table>
</div>


</script>
<script>
    var DEBUG = false;
    if (!window.console || DEBUG == false) {
        window.console = {
            log: function () {
            }
        };
    }

    var Encrypt = {
        key: 'a2ffa5c9be07488bbb04a3a47d3c5f6a',
        iv: '64175472480004614961023454661220',
        nonce: null,
        init: function () {
            var nonce = this.nonceCreat();
            this.nonce = nonce;
            return this.nonce;
        },
        nonceCreat: function () {
            var type = 0;
            var deviceId = '34:de:1a:96:49:43';
            var time = Math.floor(new Date().getTime() / 1000);
            var random = Math.floor(Math.random() * 10000);
            return [type, deviceId, time, random].join('_');
        },
        oldPwd: function (pwd) {
            return CryptoJS.SHA1(this.nonce + CryptoJS.SHA1(pwd + this.key).toString()).toString();
        },
        newPwd: function (pwd, newpwd) {
            var key = CryptoJS.SHA1(pwd + this.key).toString();
            key = CryptoJS.enc.Hex.parse(key).toString();
            key = key.substr(0, 32);
            key = CryptoJS.enc.Hex.parse(key);
            var password = CryptoJS.SHA1(newpwd + this.key).toString();
            var iv = CryptoJS.enc.Hex.parse(this.iv);
            var aes = CryptoJS.AES.encrypt(
                password,
                key,
                {iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7}
            ).toString();
            return aes;
        }
    };

    var pingRouter = function (on, off, ip) {
        var online = on || function () {
            },
            offline = off || function () {
            },
            host = ip || location.host,
            imgUrl = 'http://' + host + '/xiaoqiang/web/img/logo.png',
            time = 5000,
            timecounter = 0,
            img = null,
            wait = function () {
                console.log('pingRouter:wait');
                offline();
            },
            done = function () {
                console.log('pingRouter:done');
                window.clearInterval(timer);
                online();
            },
            loadImg = function (onload, onerror) {
                img = new Image();
                img.onload = onload;
                img.onerror = onerror;
                img.src = imgUrl + '?' + (+new Date());
            },
            timer = window.setInterval(function () {

                if ('onLine' in navigator) {
                    if (navigator.onLine) {
                        loadImg(
                            function () {
                                done();
                            }, function () {
                                wait();
                            }
                        );
                    } else {
                        wait();
                    }
                } else {
                    loadImg(function () {
                        done();
                    }, function () {
                        wait();
                    });
                }
            }, time);
    };

    var rebootWait = function (opt) {
        var action = opt.action,
            ip = opt.lanIp || window.location.host,
            refresh = opt.refresh || false,
            tStart = ( +new Date() ),
            tUse,
            dlgRebootWait = $.loadingDialog({
                title: '重启中...',
                content: '操作生效，等待设备重启...'
            }),
            online = function () {
                dlgRebootWait.content('操作生效,重启成功！');
                dlgRebootWait.time(3 * 1000);
                if (refresh) {
                    window.setTimeout('window.top.location.href="http://' + ip + '";', 3000);
                }
            },
            offline = function () {
                tUse = Math.round(( ( +new Date() ) - tStart ) / 1000);
                if (tUse > 150) {
                    dlgRebootWait.content('自动连接路由器失败，请检查无线或者网线是否连接正确。');
                    return;
                }
                dlgRebootWait.content(action + ', 等待自动跳转... 用时{$time}秒'.tmpl({time: tUse}));
            };

        window.setTimeout(function () {
            pingRouter(online, offline, ip);
        }, 1000 * 60);
    };

    (function ($) {

        function formInit(container) {
            var clsInput = 'form-item form-item-input',
                clsEmpty = 'form-item form-item-empty',
                clsDisabled = 'form-item-disabled',
                clsError = 'form-item-err',
                clsPassword = 'form-item-pwd';

            container = container || 'body';
            $(container).find('.form-item input').each(function () {
                var me = this,
                    $me = $(me),
                    parent = $(me.parentNode.parentNode),
                    label = parent.find('.k'),
                    offsetX = $me.position().left;
                if (!( this.type == 'text' || this.type == 'password' )) {
                    return;
                }
                // some input do not need init
                if ($me.hasClass('no-init')) {
                    return;
                }
                if (me.value !== '') {
                    parent[0].className = clsInput;
                } else {
                    parent[0].className = clsEmpty;
                    if (offsetX > 0) {
                        label.css({'left': offsetX + 10});
                    }
                }
                if (me.disabled) {
                    parent.addClass(clsDisabled);
                }
                if ($me.attr('data-type') === 'password') {
                    parent.addClass(clsPassword);
                    parent.append('<i class="bt-showpwd bt-showpwd-off"></i>');
                }

                label.on('click', function (e) {
                    try {
                        me.focus();
                    } catch (ex) {
                    }
                });

            });
            var focusHandler = function () {
                if (!( this.type == 'text' || this.type == 'password' )) {
                    return;
                }
                var me = $(this),
                    parent = $(this.parentNode.parentNode),
                    label = parent.find('.k'),
                    t = parent.find('.t'),
                    classname;
                if (me.hasClass('no-init')) {
                    return;
                }
                if (parent.hasClass(clsPassword)) {
                    classname = clsInput + ' ' + clsPassword;
                } else {
                    classname = clsInput;
                }
                if (parent.hasClass(clsError)) {
                    t.hide();
                }
                label.css({'left': 'auto'});
                label.hide();
                parent[0].className = classname;
            };
            var blurHandler = function () {
                var me = this,
                    $me = $(me),
                    parent = $(me.parentNode.parentNode),
                    classname,
                    label = parent.find('.k'),
                    offsetX = $me.position().left;
                if (!( this.type == 'text' || this.type == 'password' )) {
                    return;
                }
                if ($(this).hasClass('no-init')) {
                    return;
                }
                label.show();
                if (me.value == '') {
                    if (parent.hasClass(clsPassword)) {
                        classname = clsEmpty + ' ' + clsPassword;
                    } else {
                        classname = clsEmpty;
                    }
                    if (offsetX > 0) {
                        label.css({'left': offsetX + 10});
                    } else {
                        label.css({'left': 12});
                    }
                    parent[0].className = classname;
                }
            };
            var addInputEvent = function () {
                $(container).find('.form-item input')
                    .on('focus', focusHandler)
                    .on('blur', blurHandler);
            };

            var delInputEvent = function () {
                $(container).find('.form-item input').off('focus', focusHandler);
                $(container).find('.form-item input').off('blur', blurHandler);
            };
            // del password event
            $('body').undelegate('.bt-showpwd', 'click');
            $('body').delegate('.bt-showpwd', 'click', function (e) {
                console.log('showpwd');
                var me = this,
                    meclass = 'bt-showpwd',
                    formItem = $(this).closest('.form-item'),
                    input = formItem.find('input'),
                    inputValue = input.val(),
                    inputWrap = formItem.find('.v'),
                    newinput = '',
                    inputHTML = inputWrap.html();

                if (input.attr('type') == 'password') {
                    newinput = inputHTML.replace(/type\s*=\s*('|")?password('|")?/ig, 'type="text"');
                    inputWrap.html(newinput).find('input')[0].value = inputValue;
                    me.className = meclass + ' bt-showpwd-on';
                } else {
                    newinput = inputHTML.replace(/type\s*=\s*('|")?text('|")?/ig, 'type="password"');
                    inputWrap.html(newinput).find('input')[0].value = inputValue;
                    me.className = meclass + ' bt-showpwd-off';
                }

                setTimeout(function () {
                    delInputEvent();
                    addInputEvent();
                }, 0);
            });

            addInputEvent();
        }

        $.formInit = formInit;

    })(jQuery);

    /**
     * byte format
     */
    function byteFormat(number, precision, isarray) {
        var val,
            label,
            ret;
        precision = precision || 100,
            isarray = isarray || false;
        if (number > 1024 * 1024 * 1024) {
            val = Math.floor(number / 1024 / 1024 / 1024 * precision) / precision;
            label = 'GB';
        } else if (number > 1024 * 1024 && number < 1024 * 1024 * 1024) {
            val = Math.floor(number / 1024 / 1024 * precision) / precision;
            label = 'MB';
        } else {
            val = Math.floor(number / 1024 * precision) / precision;
            label = 'KB';
        }

        if (isarray) {
            ret = [val, label];
        } else {
            ret = val + label;
        }

        return ret;
    }


    function secondToHour(time) {
        var pint = function (num) {
                return parseInt(num, 10);
            },
            hour = pint(time / 3600.0),
            minute = pint((parseFloat(time / 3600.0) - hour) * 60),
            second = pint(time) - hour * 3600 - minute * 60,
            format = hour + '小时' + minute + '分' + second + '秒';
        return format;
    }

    function secondToDate(second) {
        var time = parseFloat(second),
            pint = function (num) {
                return parseInt(num, 10);
            },
            day;
        if (time !== null && time !== "") {
            if (time > 60 && time < 60 * 60) {
                time = pint(time / 60.0) + '分' + pint((parseFloat(time / 60.0) - pint(time / 60.0, 10)) * 60) + '秒';
            }
            else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                time = secondToHour(time);
            } else if (time >= 24 * 60 * 60) {
                day = pint(time / (3600.0 * 24));
                time = time - (day * 3600 * 24);
                time = day + '天 ' + secondToHour(time);
            }
            else {
                time = pint(time) + '秒';
            }
        }
        return time;
    }

    (function ($) {
        function pint(num) {
            return parseInt(num, 10);
        }

        function secondToHour(time) {
            var hour = pint(time / 3600.0),
                minute = pint((parseFloat(time / 3600.0) - hour) * 60),
                second = pint(time) - hour * 3600 - minute * 60,
                format = hour + '小时' + minute + '分' + second + '秒';
            return format;
        }

        function secondToDate(second) {
            var time = parseFloat(second),
                day;
            if (time !== null && time !== "") {
                if (time > 60 && time < 60 * 60) {
                    time = pint(time / 60.0) + '分' + pint((parseFloat(time / 60.0) - pint(time / 60.0, 10)) * 60) + '秒';
                }
                else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    time = secondToHour(time);
                } else if (time >= 24 * 60 * 60) {
                    day = pint(time / (3600.0 * 24));
                    time = time - (day * 3600 * 24);
                    time = day + '天' + secondToHour(time);
                }
                else {
                    time = pint(time) + '秒';
                }
            }
            return time;
        }

        function secondToDate2(second) {
            var time = parseFloat(second),
                num = 0,
                unit = '天';
            console.log(second, time);
            if (!isNaN(time)) {
                if (time > 60 && time < 60 * 60) {
                    num = Math.floor(time / 60.0);
                    unit = '分钟';
                } else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    num = Math.floor(time / 3600.0);
                    unit = '小时'
                } else if (time >= 24 * 60 * 60) {
                    num = Math.floor(time / (3600.0 * 24));
                    unit = '天';
                } else {
                    num = Math.floor(time);
                    unit = '秒';
                }
            }
            return {
                num: num,
                unit: unit
            };
        }

        $.secondToHour = secondToHour;
        $.secondToDate = secondToDate;
        $.secondToDate2 = secondToDate2;
    })(jQuery);


    $(document).ajaxSuccess(function (event, xhr, settings) {
        var rsp = xhr.responseText;
        rsp = $.parseJSON(rsp);
        // console.log(event, xhr, settings);
        var ignore = [
            'api\/xqsystem\/login',
            'api\/xqsystem\/upgrade_rom'
        ];
        for (var i = 0; i < ignore.length; i++) {
            var ignoreTest = new RegExp(ignore[i]);
            // console.log( ignoreTest );
            if (ignoreTest.test(settings.url)) {
                return;
            }
        }
        if (rsp.code === 401 || rsp.code === 403) {
            document.location.href = 'http://' + location.host;
        }
    });

    $.sub('wait', function (evt, data) {
        var selector = data.id;
        if (!$.waitStatus) {
            $.waitStatus = {};
        }
        $.waitStatus[selector] = $(selector).text();
        $(selector).addClass('btn-primary-disabled').prop('disabled', true).find('span').text('处理中...');
    });

    $.sub('done', function (evt, data) {
        var selector = data.id,
            text = $.waitStatus[selector];
        $(selector).removeClass('btn-primary-disabled').prop('disabled', false).find('span').text(text);
    });

    $.sub('loading:start', function () {
        var isLoading = $('html').hasClass('isloading');
        if (isLoading) {
            return;
        }
        var tplMask = '<div id="panel-loading-mask" class="panel-mask" style="position:fixed;left:0;top:0;style:none;"></div>',
            tplLoading = ''
                + '<div id="panel-loading" class="panel-loading" style="style:none;">'
                + '<img src="/xuci/assets/img/loading2.gif">'
                + '</div>',
            $mask = $(tplMask),
            $loading = $(tplLoading),
            zIndex = 10000;
        $mask.css({
            'z-index': zIndex,
            width: $(window).width() + 'px',
            height: $(window).height() + 'px'
        });
        $loading.css({'z-index': zIndex + 1});
        $mask.appendTo(document.body).show();
        $loading.appendTo(document.body).show();
        $('html').addClass('isloading');
    });

    $.sub('loading:stop', function () {
        $('html').removeClass('isloading');
        $('#panel-loading, #panel-loading-mask').remove();
    });

    // dialog block loading
    (function ($) {
        $.loadingDialog = function (config) {
            var mix = ObjectH.mix,
                _config = config || {
                    title: '',
                    content: ''
                },
                conf = mix(_config, {
                    width: 390,
                    padding: '25px 30px',
                    title: config.title,
                    content: '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: config.content}),
                    cancel: false
                }, true),
                dialog = $.dialog(conf);

            var oldcontent = dialog.content;
            dialog.content = function (cont) {
                var _cont = '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: cont});
                return oldcontent.call(dialog, _cont);
            };
            return dialog;
        }
    })(jQuery);

    // dialog alert
    (function ($) {
        $.alert = function (content, ok) {
            ok = ok || function () {
            };
            return $.dialog({
                width: 390,
                padding: '25px 30px',
                title: '提示信息',
                content: content,
                ok: ok,
                cancel: false
            });
        }
    })(jQuery);

    // dialog confirm
    (function ($) {
        $.confirm = function (content, ok, cancel) {
            var _cancel = cancel || function () {
            };
            return $.dialog({
                width: 390,
                padding: '25px 30px',
                title: '确认信息',
                content: content,
                ok: ok,
                cancel: _cancel,
                lock: true
            });
        }
    })(jQuery);

    // wechat code dialog
    $(function () {
        $('#wechatcode').click(function (e) {
            e.preventDefault();
            var $this = $(this),
                href = $this.attr('href');
            $.dialog({
                title: '官方微信',
                content: '<img width="200" src="' + href + '">',
                width: 250,
                lock: true
            });
        });
    });


    // set sys language
    (function ($) {
        $.i18nSet = function (el) {
            var $lan = $(el),
                apiGetLan = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/xqsystem/get_languages',
                apiSetlan = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/xqsystem/set_language',
                dtd = $.Deferred();

            $.get(apiGetLan, function (rsp) {
                var rsp = $.parseJSON(rsp);
                var selectContent = [];
                if (rsp.code == 0) {
                    for (var i = 0; i < rsp.list.length; i++) {
                        var item = rsp.list[i],
                            selected = item.lang == rsp.lang ? 'selected' : '',
                            option = '<option value="' + item.lang + '" ' + selected + '>' + item['name'] + '</option>';
                        // clear old conf en item
                        // if ( item.lang != 'en') {
                        selectContent.push(option);
                        // }
                    }
                    ;
                    $lan.html(selectContent.join(''));
                    dtd.resolve();
                }
            });

            $lan.on('change', function (e) {
                var el = this,
                    val = $(this).val();
                $.pub('loading:start');
                $.post(apiSetlan, {language: val}, function (rsp) {
                    var rsp = $.parseJSON(rsp);
                    if (rsp.code == 0) {
                        location.reload(1);
                    } else {
                        $.alert(rsp.msg);
                    }
                    $.pub('loading:stop');
                });
            });

            return dtd.promise();
        };
    }(jQuery));


    // global event
    (function ($) {
        var dlgReboot,
            dlgShutdown,
            dlgRouterName;

        function getNotice() {
            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/messages', function (rsp) {
                if (rsp.code == 0) {
                    var classname;
                    if (rsp.count > 0) {
                        classname = 'ico-notice-new';
                    } else {
                        classname = 'ico-notice';
                    }
                    $('#sysnotice')[0].className = classname;
                    var msgMap = {
                        '1': '<p>检测到最新版本为{$version}，<a href="/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/web/setting/upgrade">点击此处立即升级</a>。</p>',
                        '3': '<p>5G Wi-Fi启动失败，<a target="_blank" href="http://www.mi.com/service/contact/">请联系灵铱客服解决</a></p>',
                        '4': '<p>检测到与上级路由器存在IP冲突，建议切换到<a href="/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/web/setting/wan#netmode">有线中继模式</a>或者<a href="#" id="ipconflict" data-ip="{$ip}">避让IP冲突</p>'
                    };
                    var msgHTML = [];
                    for (var i = rsp.messages.length - 1; i >= 0; i--) {
                        msgHTML.push(msgMap[rsp.messages[i].type].tmpl(rsp.messages[i].data));
                    }
                    ;
                    $('#noticebar .content').html(msgHTML.join(''));

                    if (rsp.count > 0) {
                        $('#sysnotice').trigger('click');
                    }
                }
            });
        }

        function reNameHandler(e) {
            e.preventDefault();
            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/router_name')
                .done(function (rsp) {
                    if (rsp.code == 0) {
                        var html = StringH.tmpl($('#tplrename').html(), {
                            locale: StringH.encode4HtmlValue(rsp.locale),
                            name: StringH.encode4HtmlValue(rsp.name)
                        });
                        dlgRouterName = $.dialog({
                            width: 390,
                            title: '修改路由器名称',
                            content: html,
                            lock: true
                        });
                        setTimeout(function () {
                            $.formInit('.mod-rename-dlg');
                            $.selectBeautify({container: '.mod-rename-dlg'});
                        }, 100);
                    }
                });
        }

        function downloadClientHandler(e) {
            e.preventDefault();
            $.dialog({
                width: 390,
                title: '下载客户端',
                content: $('#tpldownloadclient').html(),
                lock: true
            });
            setTimeout(function () {
                $('.onlineimg').each(function () {
                    var img = new Image();
                    var el = this;
                    var remote = el.src;
                    var local = $(el).attr('src-local');
                    img.onerror = function () {
                        el.src = local;
                    }
                    img.src = remote;
                });
            }, 100);
        }

        function rebootHandler(e) {
            e.preventDefault();
            dlgReboot = $.dialog({
                width: 390,
                title: '重启路由器',
                content: $('#tplreboot').html(),
                lock: true
            });
        }

        function shutdownHandler(e) {
            e.preventDefault();
            dlgShutdown = $.dialog({
                width: 390,
                title: '路由器关机',
                content: $('#tplshutdown').html(),
                lock: true
            });
        }

        function noticeHandler(e) {
            e.preventDefault();
            var that = this,
                $this = $(this),
                pos = $('#userbar').position(),
                right,
                wt = 1160,
                wwt = $(window).width(),
                $arrow = $('#noticebar .ico-arrow');
            if ($this.hasClass('ico-notice-new')) {
                // right = wt - pos.left - 20;
                $arrow.css({'right': '10px'});
                $('#noticebar').css({'right': (wwt - wt) / 2});
                $('#noticebar').toggle();
            }
            $('#maskMenu').height($(window).height());
            $('#maskMenu').show();
        }

        function sysmenuHandler(e) {
            e.preventDefault();
            var that = this,
                $this = $(this);
            if ($this.hasClass('s-dropdown')) {
                var ww = $(window).width();
                // var rt = (ww - 1160) / 2;
                var lt = $this.offset().left + $this.outerWidth() - $('#dropmenu').width();
                $('#dropmenu').css({left: lt});
                $('#dropmenu').show();
                that.className = 'name s-dropup';
            } else {
                $('#dropmenu').hide();
                that.className = 'name s-dropdown';
            }
            $('#maskMenu').height($(window).height());
            $('#maskMenu').show();
        }

        function maskHandler(e) {
            e.preventDefault();
            $('#noticebar').hide();
            $('#dropmenu').hide();
            $('#maskMenu').hide();
            $('#sysmenu')[0].className = 'name s-dropdown';
        }

        $(function () {
            // notice
            $('#sysnotice').click(noticeHandler);
            // user dropmenu
            $('#sysmenu').click(sysmenuHandler);
            // space click
            $('#maskMenu').click(maskHandler);
            // rename
            $('body').delegate('#toRename', 'click', reNameHandler);
            // toDownloadClient
            $('body').delegate('#toDownloadClient', 'click', downloadClientHandler);
            // toReboot
            $('body').delegate('#toReboot', 'click', rebootHandler);
            // toShutdown
            $('body').delegate('#toShutdown', 'click', shutdownHandler);

            $('body').delegate('#shutdownAction', 'click', function (e) {
                e.preventDefault();
                dlgShutdown.close();
                shutdown_window();
            });

            $('body').delegate('#rebootAction', 'click', function (e) {
                e.preventDefault();
                dlgReboot.close();
                reboot_window();
            });

            $('body').delegate('#routerNameEdit', 'submit', function (e) {
                e.preventDefault();
                var validator = Valid.checkAll(this);
                var routername = $('#routername').val();
                var locale = $('#locale').val();
                if (validator) {
                    $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/set_router_name', {
                        name: routername,
                        locale: locale
                    }).done(function (rsp) {
                        if (rsp.code == 0) {
                            location.reload(1);
                        } else {
                            $.alert(rsp.msg)
                        }
                    });
                }
            });

            $('body').delegate('#ipconflict', 'click', function (e) {
                e.preventDefault();
                var api = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/r_ip_conflict',
                    ip = $(this).attr('data-ip');
                $.dialog({
                    title: '避让IP冲突',
                    content: '执行此操作，局域网IP将会变更为' + ip + '<br>' + '该过程无线网络会重启，将出现短暂掉线。',
                    lock: true,
                    ok: function () {
                        $.post(api, function (rsp) {
                            rsp = $.parseJSON(rsp);
                            if (rsp.code !== 0) {
                                alert(rsp.msg);
                            }
                        });
                    },
                    cancel: function () {
                    }
                });
            });

            // user logined and has global header get notice
            if (typeof(GLOBALHEADER) !== 'undefined' && GLOBALHEADER === true) {
//                getNotice();
            }
        });
    })(jQuery);
</script>
<script src="/xuci/assets/js/miwifi-monitor.js"></script>
<script>
    // 流量统计
    (function () {
        var IS_MOBILE = (
            navigator.userAgent.match(/Android/i)
            || navigator.userAgent.match(/webOS/i)
            || navigator.userAgent.match(/iPhone/i)
            || navigator.userAgent.match(/iPad/i)
            || navigator.userAgent.match(/iPod/i)
            || navigator.userAgent.match(/BlackBerry/i)
            || navigator.userAgent.match(/Windows Phone/i)
        );
        var PAGEURL = document.URL.split('/web/')[1];
        var PAGE_MONITOR_CONF = {
            deviceId: '6d2e3d4e-b63e-a37f-82fb-b21defee7f2e',
            isMobile: IS_MOBILE ? IS_MOBILE[0] : 'pc',
            url: PAGEURL ? '/web/' + PAGEURL : '/web/login',
            romVersion: '2.25.122',
            romChannel: 'stable',
            hardwareVersion: 'R3G'
        };
        MIWIFI_MONITOR.setProject('MIWIFIWEB');
        MIWIFI_MONITOR.log(PAGE_MONITOR_CONF, 'track');

//        $(document).ajaxSend(function (event, jqxhr, settings) {
//            var apiUrl = settings.url.split('/api/')[1],
//                api = '/api/' + apiUrl.split('?')[0],
//                apiParams = StringH.queryUrl(apiUrl);
//
//            // console.log(apiUrl, api, apiParams);
//
//            var API_MONITOR_CONF = ObjectH.mix({element: 'apicall', api: api}, [PAGE_MONITOR_CONF, apiParams]);
//            // console.log(API_MONITOR_CONF);
//            MIWIFI_MONITOR.log(API_MONITOR_CONF);
//        });
    }());
</script>

<script type="tmpl/text" id="tmplSpeedTesting">
<div class="mod-speed-testing">
    <i class="ico-speed-testing"></i>
    <p>正在测速...</p>
    <div class="loading"></div>
</div>


</script>
<script type="tmpl/text" id="tmplSpeedTestNorst">
<div class="mod-speed-testing">
    <i class="ico-speed-test"></i>
    <p>还没有进行测速</p>
    <div class="btns">
        <a href="#" class="btn btn-primary" id="btnSpeedReTest"><span>立即测速</span></a>
    </div>
</div>


</script>
<script type="tmpl/text" id="tmplSpeedTestErr">
<div class="mod-speed-testing">
    <i class="ico-speed-test-err"></i>
    <p>发生未知错误，测速失败</p>
    <div class="btns">
        <a href="#" class="btn btn-primary" id="btnSpeedReTest"><span>重新测速</span></a>
    </div>
</div>


</script>
<script type="tmpl/text" id="tmplBandTestErr">
<div class="mod-speed-testing">
    <i class="ico-speed-test-err"></i>
    <p>发生未知错误，测速失败</p>
    <div class="btns">
        <a href="#" class="btn btn-primary" id="btnBandReTest"><span>重新测速</span></a>
    </div>
</div>


</script>
<script type="tmpl/text" id="tmplSpeedResult">
<div class="mod-speed-result">
    <ul class="clearfix">
        <li class="first">
            <i class="ico-speed"></i>
            <span class="num">{$speed}</span>
            <span class="con">
                {$unit}<br>
                {$type}
            </span>
        </li>
        <li>
            <span class="num">{$bandwidth}</span>
            <span class="con">
                Mbps<br>
                外网带宽
            </span>
        </li>
    </ul>
    <div class="btns">
        <a id="btnSpeedReTest" href="#" class="btn btn-primary"><span>重新测速</span></a>
        <a href="#" class="btn btn-primary" id="btnSpeedClose"><span>完成</span></a>
        <div class="manual">测速不准？<a id="manSet" href="#"  data-upband="{$upband}" data-downband="{$downband}">手工设置</a></div>
    </div>
</div>


</script>
<script type="tmpl/text" id="tmplBandResult">
<div class="mod-speed-result">
    <ul class="clearfix">
        <li class="first">
            <span class="num">{$upband}</span>
            <span class="con">
                Mbps<br>
                上传带宽
            </span>
        </li>
        <li>
            <span class="num">{$downband}</span>
            <span class="con">
                Mbps<br>
                下载带宽
            </span>
        </li>
    </ul>
    <div class="btns">
        <a href="#" class="btn btn-primary btn-m" id="btnBandClose"><span>完成</span></a>
        <a id="btnBandReTest" href="#" class="btn btn-primary btn-m"><span>重新测速</span></a>
        <div class="manual">测速不准？<a id="manSet" href="#"  data-upband="{$upband}" data-downband="{$downband}">手工设置</a></div>

    </div>
</div>


</script>
<script type="tmpl/text" id="tmplBandResult2">
<div class="mod-speed-result">
    <ul class="clearfix">
        <li class="first">
            <span class="num" id="outband-up">{$upband}</span>
            <span class="con">
                MB/s<br>
                最高上传速度
            </span>
        </li>
        <li>
            <span class="num" id="outband-down">{$downband}</span>
            <span class="con">
               MB/s<br>
                最高下载速度
            </span>
        </li>
    </ul>
    <div class="btns">
         <a href="#" id="btnBandset" class="btn btn-dft btn-m" data-upband="{$upband*8}" data-downband="{$downband*8}"><span>限速设置</span></a>
    </div>
</div>


</script>

<script type="tmpl/html" id="tplbandsetform">
<div class="speedset" id="customset">
    <form action="/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/set_band" class="form form-horizontal form-qos" name="bandwidth" id="bandwidth" method="post">
        <input type="hidden" name="manual" value="1">
        <div class="form-item">
            <label class="k">上传</label>
            <span class="v"><input type="text" name="upload" reqMsg="上传带宽" datatype="n-6.2" minValue="0.01" maxValue="1024" class="ipt-text" value="{$upband}"></span>
            <em class="t">Mbps</em>
        </div>
        <div class="form-item">
            <label class="k">下载</label>
            <span class="v"><input type="text" name="download" reqMsg="下载带宽" datatype="n-6.2" minValue="8" maxValue="2048" class="ipt-text" value="{$downband}"></span>
            <em class="t">Mbps</em>
        </div>
        <div class="form-contral">
            <button type="submit" id="submitbandwirdh" class="btn btn-primary btn-l"><span>确定</span></button>
        </div>
    </form>
</div>


</script>
<script>
    (function ($) {

        var dlgSpeed = {}, isSpeedTest = 0;
        var getDownloadSpeed = function () {
            var dtd = $.Deferred();
            $.ajax({
                url: '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/bandwidth_test',
                type: 'POST',
                data: {'new': 1},
                dataType: 'json',
                success: function (rsp) {
                    if (rsp.code == 0) {
                        dtd.resolve(rsp);
                    } else {
                        dtd.reject();
                    }
                },
                error: function () {
                    dtd.reject();
                }
            });
            return dtd.promise();
        };
        var getUploadSpeed = function () {
            var dtd = $.Deferred();
            $.ajax({
                url: '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/xqnetdetect/netupspeed',
                type: 'POST',
                data: {},
                dataType: 'json',
                success: function (rsp) {
                    if (rsp.code == 0) {
                        dtd.resolve(rsp);
                    } else {
                        dtd.reject();
                    }
                },
                error: function () {
                    dtd.reject();
                }
            });
            return dtd.promise();
        };
        var setQosband = function (upload, download) {
            var dtd = $.Deferred();
            $.ajax({
                url: '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/set_band',
                type: 'POST',
                data: {upload: upload, download: download},
                dataType: 'json',
                success: function (rsp) {
                    if (rsp.code == 0) {
                        dtd.resolve(rsp);
                    } else {
                        dtd.reject();
                    }
                },
                error: function () {
                    dtd.reject();
                }
            });
            return dtd.promise();
        };
        var speedTest = function () {
            var dtd = $.Deferred();
            var downspeed, downband, upspeed, upband;
            var testerror = function () {
                dlgSpeed.content($('#tmplSpeedTestErr').html());
                dtd.reject();
            };
            var downtestdone = function (rsp) {
                downband = rsp.bandwidth;
                downspeed = rsp.download;
                upband = rsp.bandwidth2;
                upspeed = rsp.upload;
            };
            var uptestdone = function (rsp) {
                upband = rsp.bandwidth;
                upspeed = rsp.upload;
            };
            var setbanddone = function (rsp) {
                dtd.resolve(downband, upband, downspeed, upspeed);
            };
            // start down speed test
            getDownloadSpeed()
                .then(function (rsp) {
                    downtestdone.call(null, rsp);
                }, testerror)
                // .then( function( rsp ){
                //     uptestdone.call( null, rsp );
                //     return setQosband( upband, downband );
                // }, testerror )
                .then(function (rsp) {
                    setbanddone.call(null, rsp);
                }, testerror);

            return dtd.promise();
        };

        $.sub('speed:test', function (evt, data) {
            var dlg = data.dlg,
                ishistory = data.ishistory || false,
                downloadspeed,
                strdownspeed,
                unit,
                bandwidth,
                speedresult,
                tpl = $('#tmplSpeedResult').html(),
                testType = ishistory ? '上次测速' : '外网速度';
            dlgSpeed.testPadding = true;

            var showErr = function () {
                dlg.content($('#tmplSpeedTestErr').html());
            };
            var showRsp = function (rsp) {
                if (rsp.code === 0) {
                    downloadspeed = parseFloat(rsp.download);
                    if (downloadspeed > 1024) {
                        unit = 'MB/S';
                        strdownspeed = downloadspeed / 1024;
                    } else {
                        unit = 'KB/S';
                        strdownspeed = downloadspeed;
                    }
                    bandwidth = parseFloat(rsp.bandwidth);
                    if (rsp.bandwidth > 0) {
                        dlg.content(tpl.tmpl({
                            speed: strdownspeed.toFixed(2),
                            unit: unit,
                            bandwidth: bandwidth.toFixed(2),
                            type: testType
                        }));
                    } else {
                        dlg.content($('#tmplSpeedTestNorst').html());
                    }
                    if (!ishistory) {
                        dlgSpeed.needreload = true;
                    }
                } else {
                    showErr();
                }
            };
            if (ishistory) {
                $.ajax({
                    url: '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/bandwidth_test',
                    type: 'POST',
                    dataType: 'json',
                    data: {history: 1}
                }).done(function (rsp) {
                    showRsp.call(null, rsp);
                    dlgSpeed.testPadding = false;
                }).fail(function () {
                    showErr();
                    dlgSpeed.testPadding = false;
                });
            } else {
                $.when(speedTest())
                    .done(function (downband, upband, downspeed, upspeed) {
                        if (manual == 0) {
                            downband == "--";
                            downspeed = "--";
                            upspeed = "--";
                            $('#testBand').text("开始测速");
                        }
                        showRsp.call(null, {
                            code: 0,
                            download: downspeed,
                            bandwidth: downband
                        });
                        dlgSpeed.testPadding = false;
                    })
                    .fail(function () {
                        showErr();
                        dlgSpeed.testPadding = false;
                    });
            }
        });

        // set bandwidth form callback
        function setBandWidth(e) {
            e.preventDefault();
            var tar = e.target,
                formName = tar.name,
                requestURL = tar.action,
                requestData = $(tar).serialize(),
                validate = Valid.checkAll($('#bandwidth')[0]);

            if (validate) {
                $.pub('loading:start');
                $.ajax({
                    url: requestURL,
                    data: requestData,
                    type: 'POST',
                    dataType: 'json'
                })
                    .done(function (rsp) {
                        if (rsp.code === 0) {
                            if (dlgSpeed && dlgSpeed.options && dlgSpeed.options.qostestok) {
                                dlgSpeed.options.qostestok();
                            } else {
                                location.reload(1);
                            }
                        } else {
                            $.alert(rsp.msg);
                        }
                        $.pub('loading:stop');
                    });
            }
        }

        $.sub('qos:test', function (evt, data) {
            var requestURL = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/bandwidth_test',
                requestData = {history: 1};
            if (data.st) {
                $.getJSON(requestURL, requestData, function (rsp) {
                    if (rsp.code == 0) {
                        if (rsp.manual === 0) {
                            dlgSpeed = $.dialog({
                                title: '手工设置外网带宽',
                                content: $('#tplbandsetform').html().tmpl({
                                    upband: "",
                                    downband: ""
                                }),
                                lock: true,
                                qostestok: function () {
                                    data.cb();
                                }

                            });
                            setTimeout(function () {
                                $.formInit();
                            }, 100);
                        } else {
                            data.cb();
                        }
                    }
                });

            } else {
                data.cb();
            }

        });

        $.sub('band:test', function (evt, data) {
            var dlg = data.dlg,
                tpl = $('#tmplBandResult').html(),
                tpl2 = $('#tmplBandResult2').html();
            var showRsp = function (downband, upband, downspeed, upspeed) {
                var result = tpl.tmpl({
                    downband: downband,
                    upband: upband
                });
                var result2 = tpl2.tmpl({
                    downband: downband,
                    upband: upband
                });
                dlg.content(result);
                $('#speedresult').html(result2);
            };
            var showErr = function () {
                dlg.content($('#tmplBandTestErr').html());
            };
            dlgSpeed.testPadding = true;
            $.when(speedTest())
                .done(function (downband, upband, downspeed, upspeed) {
                    showRsp.apply(null, [downband, upband, downspeed, upspeed]);
                    dlgSpeed.testPadding = false;
                    dlgSpeed.needreload = true;
                })
                .fail(function () {
                    showErr();
                    dlgSpeed.testPadding = false;
                });
        });

        $.sub('speed:history', function () {
            var requestURL = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/bandwidth_test',
                requestData = {history: 1};
            $.getJSON(requestURL, requestData, function (rsp) {
                if (rsp.code == 0) {
                    var unit = 'KB/S';
                    var speed = parseFloat(rsp.download);
                    var bandwidth = parseFloat(rsp.bandwidth);
                    var bandwidth2 = parseFloat(rsp.bandwidth2);
                    var strbw, statusInternet, bandwidthval, bandwidth2val;
                    if (bandwidth === 0) {
                        strbw = '--';
                        bandwidthval = "--";
                        bandwidth2val = "--";
                        statusInternet = "点击测速";
                        $('#retestSpeed').text("开始测速");
                        $('#manualSetting').text("手工设置");
                    } else {
                        isSpeedTest = 1;
                        strbw = bandwidth.toFixed(2);
                        bandwidthval = bandwidth.toFixed(2);
                        statusInternet = "带宽<b class=bandwidthval>" + bandwidthval + "</b>M";
                        bandwidth2val = bandwidth2.toFixed(2);
                    }
                    if (speed > 1024) {
                        unit = 'MB/S';
                        speed = speed / 1024;
                    }
                    // $( '#maxSpeed' ).html( speed );
                    // $( '#maxSpeedunit' ).html( unit );
                    // $( '#downloadspeed' ).html( speed );
                    // $( '#downloadspeedunit' ).html( unit );
                    $('.bandwidthval').text(strbw);
                    $('#banddownload').text(bandwidthval);
                    $('#statusInternet').html(statusInternet);
                    $('#bandupload').text(bandwidth2val);
                    $('#btnBandset').attr('data-upband', bandwidth2.toFixed(2)).attr('data-downband', bandwidth.toFixed(2));
                }
            });
        });

        $(function () {
            $('#btnSpeedTest').on('click', function (e) {
                e.preventDefault();
                dlgSpeed = $.dialog({
                    title: '网络速度',
                    width: 740,
                    content: $('#tmplSpeedTesting').html(),
                    lock: true,
                    padding: 0,
                    beforeunload: function () {
                        if (dlgSpeed.testPadding) {
                            alert('正在测速，请等待。');
                            return false;
                        }
                        if (dlgSpeed.needreload) {
                            $.pub('speed:history');
                        }
                    }
                });

                // $.pub( 'speed:test', {dlg: dlgSpeed} );
                $.pub('band:test', {dlg: dlgSpeed});

            });

            $('body').delegate('.btnBandTest', 'click', function (e) {
                e.preventDefault();
                dlgSpeed = $.dialog({
                    title: '外网带宽检测',
                    width: 740,
                    content: $('#tmplSpeedTesting').html(),
                    lock: true,
                    padding: 0,
                    beforeunload: function () {
                        if (dlgSpeed.testPadding) {
                            alert('正在测速，请等待。');
                            return false;
                        }
                        if (dlgSpeed.needreload) {
                            window.top.location.reload(1);
                        }
                    }
                });

                $.pub('band:test', {dlg: dlgSpeed});

            });

            $('body').delegate('#btnSpeedReTest', 'click', function (e) {
                e.preventDefault();
                dlgSpeed.content($('#tmplSpeedTesting').html());
                $.pub('speed:test', {dlg: dlgSpeed});
            });

            $('body').delegate('#btnSpeedClose', 'click', function (e) {
                e.preventDefault();
                dlgSpeed.close();
            });

            $('body').delegate('#btnBandReTest', 'click', function (e) {
                e.preventDefault();
                dlgSpeed.content($('#tmplSpeedTesting').html());
                $.pub('band:test', {dlg: dlgSpeed});
            });

            $('body').delegate('#btnBandClose', 'click', function (e) {
                e.preventDefault();
                if (dlgSpeed && dlgSpeed.options && dlgSpeed.options.qostestok) {
                    dlgSpeed.options.qostestok();
                }
                dlgSpeed.close();
            });

            $('body').delegate('.get-history-speed', 'click', function (e) {
                e.preventDefault();
                dlgSpeed = $.dialog({
                    title: '网络速度',
                    width: 740,
                    content: '<div class="mod-speed-testing">处理中...</div>',
                    lock: true,
                    padding: 0,
                    beforeunload: function () {
                        if (dlgSpeed.testPadding) {
                            alert('正在测速，请等待。');
                            return false;
                        }
                        if (dlgSpeed.needreload) {
                            $.pub('speed:history');
                        }
                    }
                });
                $.pub('speed:test', {dlg: dlgSpeed, ishistory: true});
            });

            $('body').delegate('#btnBandset', 'click', function (e) {
                e.preventDefault();
                var upband = $(this).attr('data-upband'),
                    downband = $(this).attr('data-downband');
                dlgSpeed = $.dialog({
                    title: '手工设置外网带宽',
                    content: $('#tplbandsetform').html().tmpl({
                        upband: upband,
                        downband: downband
                    }),
                    lock: true
                });
                setTimeout(function () {
                    $.formInit();
                }, 100);
            });

            $('body').delegate('#manSet', 'click', function (e) {
                e.preventDefault();
                var upband = $(this).attr('data-upband'),
                    downband = $(this).attr('data-downband'),
                    upbandTxt,
                    downbandTxt;
                if (downband == 0) {
                    upbandTxt = downbandTxt = "";

                } else {
                    upbandTxt = upband;
                    downbandTxt = downband;
                }
                $.dialog({
                    title: '手工设置外网带宽',
                    content: $('#tplbandsetform').html().tmpl({
                        upband: upbandTxt,
                        downband: downbandTxt
                    }),
                    lock: true
                });
                setTimeout(function () {
                    $.formInit();
                }, 100);
            });

            $('body').delegate('#bandwidth', 'submit', setBandWidth);
        });
    })(jQuery);
</script>

<script type="tmpl/html" id="limit-set-tpl">
    <div class="speedset" id="customset">
        <form class="form form-horizontal form-qos" name="bandwidth" id="limit-form">
            <div class="form-item form-item-input">
                <label class="k">上传</label>
                <span class="v">
                    <input type="text" id="limit-up-input" reqMsg="上传带宽" datatype="n-6.2" minValue="0.01" maxValue="" class="ipt-text" value="{$up}">
                </span>
                <em class="t">KB/S</em>
            </div>
            <div class="form-item form-item-input">
                <label class="k">下载</label>
                <span class="v">
                    <input type="text" id="limit-down-input" reqMsg="下载带宽" datatype="n-6.2" minValue="8" maxValue="" class="ipt-text" value="{$down}">
                </span>
                <em class="t">KB/S</em>
            </div>
            <div class="form-contral">
                <button type="button" id="limit-submit-button" class="btn btn-primary btn-l"><span>确定</span></button>
            </div>
        </form>
    </div>


</script>
<script type="tmpl/html" id="tpldevlist1-back">
<tr>
    <td>{$devname}</td>
    <td class="con">{$ip} <br> {$mac}</td>
    <td class="con"><i class="ico ico-upspeed"></i> {$upspeed}/S <br><i class="ico ico-downspeed"></i> {$downspeed}/S</td>
    <td class="con center">系统自动</td>
</tr>


</script>
<script type="tmpl/html" id="tpldevlist">
<tr data-mac="{$mac}">
    <td>{$devname}</td>
    <td class="con">{$ip} <br> {$mac}</td>
    <td class="con"><i class="ico ico-upspeed"></i> {$upspeed}/S <br><i class="ico ico-downspeed"></i> {$downspeed}/S</td>
    <td class="con"><i class="ico ico-upspeed"></i> {if($upmax == 0)}无限制{else}{$upmax}KB/S{/if} <br><i class="ico ico-downspeed"></i> {if($downmax == 0)}无限制{else}{$downmax}KB/S{/if}</td>
</tr>


</script>
<script type="tmpl/html" id="tpldevlist2">
<tr data-mac="{$mac}">
    <td>{$devname}</td>
    <td class="con">{$ip} <br> {$mac}</td>
    <td class="con"><i class="ico ico-upspeed"></i> {$upspeed}/S <br><i class="ico ico-downspeed"></i> {$downspeed}/S</td>
    <td class="center">
        {$levelvalue}
    </td>
</tr>


</script>
<script type="tmpl/html" id="tpldevlist3">
<tr data-mac="{$mac}">
    <td>{$devname}</td>
    <td class="con">{$ip} <br> {$mac}</td>
    <td class="con"><i class="ico ico-upspeed"></i> {$upspeed}/S <br><i class="ico ico-downspeed"></i> {$downspeed}/S</td>
    <td class="con"><i class="ico ico-upspeed"></i> {if($upmax == 0)}无限制{else}{$upmax}KB/S{/if} <br><i class="ico ico-downspeed"></i> {if($downmax == 0)}无限制{else}{$downmax}KB/S{/if}</td>
</tr>


</script>
<script type="tmpl/html" id="tplqoseditform0">
<div class="form-qos-set" id="qosEditForm">
    <form name="qoseditform" id="qoseditform">
    <table class="table table-devices form-table">
        <thead>
            <tr>
                <th width="270">设备名称</th>
                <th width="200">设备信息</th>
                <th width="110">当前网速</th>
                <th class="center">上传速度</th>
                <th class="center">下载速度</th>
            </tr>
        </thead>
        <tbody>
        {for(var i = 0,len = $devlist.length; i<len; i++)}
            <tr data-mac="{$devlist[i].mac}">
                <td>{$devlist[i].devname}</td>
                <td class="con">{$devlist[i].ip} <br> {$devlist[i].mac}</td>
                <td class="con"><i class="ico ico-upspeed"></i> {$devlist[i].upspeed}/S <br><i class="ico ico-downspeed"></i> {$devlist[i].downspeed}/S</td>
                <td class="center form-item">
                    <input class="ipt-text" reqMsg="上传速度" datatype="n-10.2" minValue="0" name="upmax" value="{$devlist[i].upmax}"> KB/S <em></em>
                </td>
                <td class="center form-item">
                    <input class="ipt-text" reqMsg="下载速度" datatype="n-10.2" minValue="0"  name="downmax" value="{$devlist[i].downmax}"> KB/S <em></em>
                </td>
            </tr>
        {/for}
        </tbody>
    </table>
    <div class="btns">
        <button type="button" id="btnSaveQosSet" class="btn btn-primary btn-l" data-mode="{$mode}"><span>确定</span></button>
    </div>
    </form>
</div>


</script>
<script type="tmpl/html" id="tplqoseditform1">
<div class="form-qos-set" id="qosEditForm">
    <form name="qoseditform" id="qoseditform">
    <table class="table table-devices form-table">
        <thead>
            <tr>
                <th width="270">名称</th>
                <th width="270">IP和MAC</th>
                <th width="250">当前网速</th>
                <th class="center">优先级</th>
            </tr>
        </thead>
        <tbody>
        {for(var i=0,len=$devlist.length;i<len;i++)}
            <tr class="form-item" data-mac="{$devlist[i].mac}">
                <td>{$devlist[i].devname}</td>
                <td class="con">{$devlist[i].ip} <br> {$devlist[i].mac}</td>
                <td class="con"><i class="ico ico-upspeed"></i> {$devlist[i].upspeed}/S <br><i class="ico ico-downspeed"></i> {$devlist[i].downspeed}/S</td>
                <td class="center">
                    <select name="level">
                        <option value="1" {if($devlist[i].level == 1)}selected="selected"{/if}>低</option>
                        <option value="2" {if($devlist[i].level == 2 || $level == 0)}selected="selected"{/if}>中</option>
                        <option value="3" {if($devlist[i].level == 3)}selected="selected"{/if}>高</option>
                    </select>
                </td>
            </tr>
        {/for}
        </tbody>
    </table>
    <div class="btns">
        <button type="button" id="btnSaveQosSet" class="btn btn-primary btn-l" data-mode="{$mode}"><span>确定</span></button>
    </div>
    </form>
</div>


</script>
<script type="tmpl/html" id="tplqoseditform2">
<div class="form-qos-set" id="qosEditForm">
    <form name="qoseditform" id="qoseditform">
    <table class="table table-devices form-table">
        <thead>
            <tr>
                <th width="270">设备名称</th>
                <th width="200">设备信息</th>
                <th width="110">当前网速</th>
                <th class="center">上传速度</th>
                <th class="center">下载速度</th>
            </tr>
        </thead>
        <tbody>
        {for(var i = 0,len = $devlist.length; i<len; i++)}
            <tr data-mac="{$devlist[i].mac}">
                <td>{$devlist[i].devname}</td>
                <td class="con">{$devlist[i].ip} <br> {$devlist[i].mac}</td>
                <td class="con"><i class="ico ico-upspeed"></i> {$devlist[i].upspeed}/S <br><i class="ico ico-downspeed"></i> {$devlist[i].downspeed}/S</td>
                <td class="center form-item">
                    <input class="ipt-text" reqMsg="上传速度" datatype="n-10.2" minValue="0" name="upmax" value="{$devlist[i].upmax}"> KB/S <em></em>
                </td>
                <td class="center form-item">
                    <input class="ipt-text" reqMsg="下载速度" datatype="n-10.2" minValue="0"  name="downmax" value="{$devlist[i].downmax}"> KB/S <em></em>
                </td>
            </tr>
        {/for}
        </tbody>
    </table>
    <div class="btns">
        <button type="button" id="btnSaveQosSet" class="btn btn-primary btn-l" data-mode="{$mode}"><span>确定</span></button>
    </div>
    </form>
</div>


</script>
<script>
    var modelQos = (function () {
        function setDefaultMode() {
            $.pub('loading:start');
            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_mode', {mode: 3}, function (rsp) {
                $.pub('loading:stop');
                if (rsp.code == 0) {
                    //window.location.reload();
                    qosStatus();
                } else {
                    arguments.callee();
                }
            });
        }

        // get Qos status
        function qosStatus() {
            $.pub('loading:start');
            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_info', {}, function (rsp) {
                $.pub('loading:stop');
                $('#qosset').show();
                if (rsp.code == 0) {
                    if (rsp.status.mode < 3 && rsp.status.on == 1) {
                        $.pub('loading:start');
                        setDefaultMode();
                        return;
                    }
                    modeGlobal = rsp.status.mode;
                    qosLimit(rsp);
                    var btnqos = $('#btnqos')[0],
                        listqos = $('#qosset'),
                        listqosoff = $('#qosoff');
                    if (rsp.status.on === 0) {
                        btnqos.className = 'btn-switch btn-switch-off';
                        listqos.hide();
                        listqosoff.show();
                    } else {
                        btnqos.className = 'btn-switch btn-switch-on';
                        listqos.show();
                        listqosoff.hide();
                    }
                    var model,
                        upband = rsp.band.upload,
                        downband = rsp.band.download;

                    if (downband > 50) {
                        $('.mod-qos-alert').show();
                    } else {
                        $('.mod-qos-alert').hide();
                    }
                    if (downband == 0) {
                        $('.mod-bandwidth .nospeed').show();
                        $('.mod-bandwidth .hasspeed').hide();
                        $('.result-tip').show();
                        return;
                    }
                    $('.mod-bandwidth .nospeed').hide();
                    $('.mod-bandwidth .hasspeed').show();
                    $('.result-tip').hide();

                    var tpl2 = $('#tmplBandResult2').html();
                    var result2 = tpl2.tmpl({
                        downband: parseFloat(downband / 8).toFixed(2),
                        upband: parseFloat(upband / 8).toFixed(2)
                    });
                    $('#speedresult').html(result2);

                    if (rsp.status.on === 1) {
                        model = rsp.status.mode;
                        //var idx = [0,1,2][model];
                        var idx = model;
                        $('#qosmode li').removeClass('active');
                        $('#qosmodedesc p').hide();

                        $('#qosmode li').eq(idx).addClass('active');
                        $('#qosmodedesc p').eq(idx).show();
                        // rander devlists
                        var tpldata = randerDevlist(rsp);
                        randerMode(tpldata);
                    }
                }
            });
        }

        function qosLimit(rspBand) {
            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_info', {}, function (rsp) {
                var htmlGuest = $('#guest-limit-script').html();
                var htmlLocal = $('#local-limit-script').html();
                var outbandUp = rspBand.band.upload * 1024 / 8;
                var outbandDown = rspBand.band.download * 1024 / 8;
                $('#guest-limit').html(htmlGuest.tmpl({
                    'up': (rsp.guest.percent_up * outbandUp).toFixed(2),
                    'down': (rsp.guest.percent * outbandDown).toFixed(2)
                }));
                $('#local-limit').html(htmlLocal.tmpl({
                    'up': (rsp.local.percent_up * outbandUp).toFixed(2),
                    'down': (rsp.local.percent * outbandDown).toFixed(2)
                }));
                if (rsp.guest.percent_up == 0) {
                    $('#guest-limit li:first .num').text('无限制').addClass('txt');
                    $('#guest-limit li:first .con').hide();
                }
                if (rsp.guest.percent == 0) {
                    $('#guest-limit li:last .num').text('无限制').addClass('txt');
                    $('#guest-limit li:last .con').hide();
                }
                if (rsp.local.percent_up == 0) {
                    $('#local-limit li:first .num').text('无限制').addClass('txt');
                    $('#local-limit li:first .con').hide();
                }
                if (rsp.local.percent == 0) {
                    $('#local-limit li:last .num').text('无限制').addClass('txt');
                    $('#local-limit li:last .con').hide();
                }
                $('body').delegate('.btn-limit', 'click', function (e) {
                    e.preventDefault();
                    var self = this;
                    var mode = $(self).data('mode');
                    if (mode == 'local') {
                        var title = '路由器自身上传下载限速';
                    } else {
                        title = '访客WiFi限速';
                    }
                    var up = $(this).data('up'),
                        down = $(this).data('down');
                    $.dialog({
                        title: title,
                        content: $('#limit-set-tpl').html().tmpl({
                            up: up,
                            down: down
                        }),
                        lock: true
                    });
                    $('#limit-up-input').attr('maxValue', outbandUp);
                    $('#limit-down-input').attr('maxValue', outbandDown);
                    $('#limit-submit-button').bind('click', function () {

                        if ($('#limit-form .form-item-err').length != 0) {
                            return;
                        }

                        //   var validator = Valid.checkAll($('#limit-form')[0]);
                        //   if(!validator){
                        //       return;
                        //   }
                        if (mode == 'guest') {
                            var requestUrl = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_guest';
                        } else if (mode == 'local') {
                            var requestUrl = '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_xq';
                        }
                        var limitUp = $('#limit-up-input').val();
                        var limitDown = $('#limit-down-input').val();
                        limitUp = limitUp / outbandUp;
                        limitDown = limitDown / outbandDown;
                        $.getJSON(requestUrl, {'percent': limitDown, 'percent_up': limitUp}, function (rsp) {
                            $.pub('loading:stop');
                            if (rsp.code == 0) {
                                window.location.reload();
                            } else {
                                $.alert('系统错误，请重试');
                            }
                        });
                    });
                    /*
                    setTimeout(function(){
                        $.formInit();
                    }, 100);
                    */
                });
            });
        }

        function randerMode1(tpldata) {
            var tpl = $('#tpldevlist1').html();
            var arrHtml = [];
            if (tpldata.length == 0) {
                $('#devlistcustom').html('<tr><td colspan="4">暂无设备接入</td></tr>');
                return;
            }
            for (var i = 0; i < tpldata.length; i++) {
                arrHtml.push(tpl.tmpl(tpldata[i]));
            }
            $('#devlistauto').html(arrHtml.join(''));
            $('.table-devices').hide();
            $('#tableauto').show();
        }

        function randerMode2(tpldata) {
            var tpl = $('#tpldevlist2').html();
            var arrHtml = [];
            if (tpldata.length == 0) {
                $('#devlistcustom').html('<tr><td colspan="4">暂无设备接入</td></tr>');
                return;
            }
            for (var i = 0; i < tpldata.length; i++) {
                arrHtml.push(tpl.tmpl(tpldata[i]));
            }
            $('#devlistpriority').html(arrHtml.join(''));
            $('.table-devices').hide();
            $('#tablepriority').show();
        }

        function randerMode3(tpldata) {
            var tpl = $('#tpldevlist3').html();
            var arrHtml = [];
            if (tpldata.length == 0) {
                $('#devlistcustom').html('<tr><td colspan="4">暂无设备接入</td></tr>');
                return;
            }
            for (var i = 0; i < tpldata.length; i++) {
                arrHtml.push(tpl.tmpl(tpldata[i]));
            }
            $('#devlistcustom').html(arrHtml.join(''));
            $('.table-devices').hide();
            $('#tablecustom').show();
        }

        //var randerMode = [randerMode1, randerMode2, randerMode3];
        function randerMode(tpldata) {
            var tpl = $('#tpldevlist').html();
            var arrHtml = [];
            if (tpldata.length == 0) {
                $('#devlistcustom').html('<tr><td colspan="4">暂无设备接入</td></tr>');
                return;
            }
            for (var i = 0; i < tpldata.length; i++) {
                arrHtml.push(tpl.tmpl(tpldata[i]));
            }
            $('#devlistcustom').html(arrHtml.join(''));
            $('.table-devices').hide();
            $('#tablecustom').show();
        }

        function randerModeEdit(tpldata, mode) {
            var tpl = [$('#tplqoseditform0'), $('#tplqoseditform1'), $('#tplqoseditform2')][mode].html();
            return tpl.tmpl({devlist: tpldata, mode: mode});
        }

        // rander devices list DOM
        function randerDevlist(rsp, callback) {
            var devlist = rsp.list,
                devdata = [];
            for (var i = 0; i < devlist.length; i++) {
                //访客wifi设备不需要单独展示
                if (devlist[i].port != 3) {
                    var index = i,
                        upspeed = byteFormat(devlist[i].statistics.upspeed, 100),
                        downspeed = byteFormat(devlist[i].statistics.downspeed, 100),
                        upmax = devlist[i].qos.upmax,
                        downmax = devlist[i].qos.downmax,
                        upmaxper = devlist[i].qos.upmaxper,
                        maxdownper = devlist[i].qos.maxdownper,
                        level = devlist[i].qos.level,
                        ip = devlist[i].ip,
                        mac = devlist[i].mac,
                        dname = devlist[i]['name'],
                        tpldata = {
                            index: index,
                            devname: dname,
                            ip: ip,
                            mac: mac,
                            upspeed: upspeed,
                            downspeed: downspeed,
                            upmax: parseFloat(upmax).toFixed(2),
                            downmax: parseFloat(downmax).toFixed(2),
                            upmaxper: upmaxper,
                            downmaxper: maxdownper,
                            level: level,
                            levelvalue: ['未设置', '低', '中', '高'][level]
                        };
                    devdata.push(tpldata);
                }

            }
            return devdata;
        }

        // switch QoS status
        function qosSwitch() {
            var btnqos = $('#btnqos');
            btnqos.on('click', function (e) {
                e.preventDefault();
                var st = $(this).hasClass('btn-switch-on') ? 0 : 1,
                    btn = this;
                $.pub('qos:test', {
                    st: st, cb: function () {
                        $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_switch', {'on': st}, function (rsp) {
                            if (rsp.code == 0) {
                                location.reload(1);
                            }
                        });
                    }
                });

            });
        }

        // add Event
        function addEvent() {

            $('#qosmode li').on('click', function (e) {
                var checked = $(this).hasClass('active');
                if (!checked) {
                    var self = this;
                    $.pub('loading:start');
                    var val = $(this).attr('data-value');
                    $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_mode', {mode: val}, function (rsp) {
                        $.pub('loading:stop');
                        if (rsp.code === 0) {
                            // window.location.reload();
//                        qosStatus();
                            $($('#qosmode li')[0]).parent().children().removeClass('active');
                            $(self).addClass('active');
                            var idx = $(self).data('value');
                            $('#qosmodedesc p').hide().eq(idx).show();
                        } else {
                            $.alert(rsp.msg);
                        }
                    });
                }
            });

            $('body').delegate('.btn-editqos', 'click', function (e) {
                e.preventDefault();
                var root = $(e.target).parents('tr');
                root.find('td').each(function () {
                    $(this).addClass('toedit');
                });
            });

            $('body').delegate('.btn-cancel-qoslimit', 'click', function (e) {
                e.preventDefault();
                var root = $(e.target).parents('tr');
                var formObj = document.appqos;
                root.find('td').each(function () {
                    $(this).removeClass('toedit');
                });
                Valid.resetAll(formObj);
            });

            $('body').delegate('.btn-del-qoslimit', 'click', function (e) {
                e.preventDefault();

                var delqos = (function (evt) {
                    var e = evt;
                    return function () {
                        var root = $(e.target).parents('tr'),
                            mac = root.attr('data-mac');
                        $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_offlimit', {mac: mac}, function (rsp) {
                            if (rsp.code == 0) {
                                qosStatus();
                            } else {
                                alert(rsp.msg);
                            }
                        });
                    }
                })(e);

                $.confirm('你确定要清除这个设备的QoS配置？', delqos);

            });

            $('#refresh').on('click', function (e) {
                e.preventDefault();
                $('#devloading').show();
                qosStatus();
            });

            $('body').delegate('.btnEditQos', 'click', function (e) {
                e.preventDefault();
                $.pub('loading:start');
                var mode = $(this).attr('data-mode');
                mode = parseInt(mode, 10);
                $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_info', {}, function (rsp) {
                    $.pub('loading:stop');
                    var tpldata = randerDevlist(rsp);
                    var deveditform = randerModeEdit(tpldata, mode);
                    $.dialog({
                        title: '设置QoS',
                        content: deveditform,
                        width: 930,
                        lock: true,
                        fixed: false
                    });
                });
            });

            $('body').delegate('#btnSaveQosSet', 'click', function (e) {
                e.preventDefault();
                var formdata = [];
                $('#qosEditForm tbody tr').each(function () {
                    var that = this,
                        $this = $(this),
                        mac = $this.attr('data-mac'),
                        level = $this.find('[name=level]').val(),
                        $maxup = $this.find('[name=upmax]'),
                        maxup = $maxup.val(),
                        $maxdown = $this.find('[name=downmax]'),
                        maxdown = $maxdown.val();
                    /*
                                    if ( mode == 1) {
                                        maxup = level;
                                        maxdown = level;
                                    }
                                    */

                    formdata.push({
                        mac: mac,
                        maxup: maxup,
                        maxdown: maxdown
                    });

                });

                var validator = Valid.checkAll($('#qoseditform')[0]);
                if (validator) {
                    $.pub('loading:start');
                    $.ajax({
                        url: '/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_limits',
                        type: 'POST',
                        dataType: 'json',
                        data: {data: ObjectH.stringify(formdata)}
                    }).done(function (rsp) {
                        if (rsp.code == 0) {
                            $.getJSON('/cgi-bin/luci/;stok=f482053b508cea6a8b637bf3f6c98f25/api/misystem/qos_mode', {mode: modeGlobal}, function (rsp) {
                                location.reload(1);
                            });
                        } else {
                            $.pub('loading:stop');
                            $.alert(rsp.msg);
                        }
                    }).fail(function () {
                        $.alert('系统错误，请重试');
                        setTimeout(function () {
                            location.reload(1);
                        }, 1000);
                        $.pub('loading:sop');
                    });
                }
            });
        }

        return {
            init: function () {
//                qosStatus();
                qosSwitch();
                addEvent();
            }
        }
    }());
    $(function () {
//        modelQos.init();
        getfoot()
    });

    function getfoot() {
        $.post("/cgi-bin/status.lua", {getcfg: 1}, function (response, status, xhr) {
            if (response.code === 0) {
                document.getElementById('ft').innerHTML = template('ft_template', {
                    data: response
                });
            }
        }, "json");
    }


</script>
<div></div>
